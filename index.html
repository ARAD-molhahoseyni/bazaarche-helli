<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> 10Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ | Ø¯Ø¨ÛŒØ±Ø³ØªØ§Ù† Ø¹Ù„Ø§Ù…Ù‡ Ø­Ù„ÛŒ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --muted: #94a3b8;
      --bg: #0f172a;
      --card: rgba(15, 23, 42, 0.9);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Vazirmatn', system-ui, sans-serif;
      background: radial-gradient(circle at top, #1d4ed8 0%, #0f172a 55%);
      color: #f8fafc;
      min-height: 100vh;
    }
    a { color: inherit; text-decoration: none; }
    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 20px 60px;
    }
    .hero {
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 24px;
      backdrop-filter: blur(8px);
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    .hero h1 { font-size: 2.4rem; margin-bottom: 8px; }
    .hero p { color: #cbd5f5; margin-bottom: 12px; }
    .hero .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(37,99,235,0.2);
      color: #bfdbfe;
      padding: 6px 18px;
      border-radius: 999px;
      font-size: 0.95rem;
      font-weight: 600;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 15px 45px rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .card.clickable { cursor: pointer; transition: transform 0.25s, border 0.25s; }
    .card.clickable:hover { transform: translateY(-6px); border-color: rgba(37,99,235,0.4); }
    .card h2, .card h3 { margin: 0 0 12px; font-size: 1.4rem; }
    .card p { margin: 0; color: #cbd5f5; line-height: 1.6; }
    .form-group { margin-bottom: 18px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; }
    input, select, textarea {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(15,23,42,0.6);
      color: #fff;
      font-family: inherit;
      font-size: 1rem;
      transition: border 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    textarea { resize: vertical; min-height: 110px; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 22px;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(37,99,235,0.35); }
    .btn.success { background: linear-gradient(135deg, #16a34a, #15803d); }
    .btn.danger { background: linear-gradient(135deg, #dc2626, #b91c1c); }
    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .panel { display: none; animation: fadeIn 0.4s ease; }
    .panel.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .stat-card {
      background: rgba(15,23,42,0.8);
      border-radius: 16px;
      padding: 18px;
      border: 1px solid rgba(148,163,184,0.2);
    }
    .stat-title { font-size: 0.9rem; color: #cbd5f5; }
    .stat-value { font-size: 1.8rem; font-weight: 700; margin-top: 6px; }
    .table-wrap {
      margin-top: 20px;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.05);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(15,23,42,0.8);
    }
    th, td {
      padding: 12px 16px;
      text-align: center;
    }
    th {
      background: rgba(15,23,42,0.95);
      font-weight: 600;
      color: #bfdbfe;
    }
    tr:nth-child(even) td { background: rgba(15,23,42,0.7); }
    tr:hover td { background: rgba(37,99,235,0.08); }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .badge.cash { background: rgba(22,163,74,0.2); color: #bbf7d0; }
    .badge.debt { background: rgba(220,38,38,0.25); color: #fecdd3; }
    .search-results {
      margin-top: 6px;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      max-height: 220px;
      overflow-y: auto;
      background: rgba(15,23,42,0.95);
      display: none;
    }
    .search-item {
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .search-item:hover { background: rgba(37,99,235,0.12); }
    .tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    .tab-btn {
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: rgba(148,163,184,0.15);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: rgba(37,99,235,0.25);
      border-color: rgba(37,99,235,0.4);
    }
    .toast-container {
      position: fixed;
      inset-inline-start: 20px;
      bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 999;
    }
    .toast {
      min-width: 240px;
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 600;
      color: #fff;
      background: rgba(37,99,235,0.9);
      box-shadow: 0 10px 35px rgba(0,0,0,0.35);
      animation: slideIn 0.3s ease;
    }
    .toast.success { background: rgba(22,163,74,0.9); }
    .toast.error { background: rgba(220,38,38,0.9); }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
      .app-shell { padding: 20px 16px 50px; }
      .hero h1 { font-size: 1.9rem; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="hero">
      <div class="badge">ğŸ“ Ø¯Ø¨ÛŒØ±Ø³ØªØ§Ù† Ø¹Ù„Ø§Ù…Ù‡ Ø­Ù„ÛŒ â€“ Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ</div>
      <h1>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø¬Ø´Ù†ÙˆØ§Ø±Ù‡ Ù…Ø¯Ø±Ø³Ù‡</h1>
      <p>Ø«Ø¨Øª ÙØ±ÙˆØ´ØŒ Ú©Ù†ØªØ±Ù„ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ ØºØ±ÙÙ‡â€ŒØ¯Ø§Ø±Ø§Ù†</p>
    </header>

    <section id="entryScreen" class="grid-2 panel active">
      <div class="card clickable" onclick="showPanel('stallLoginPanel')">
        <h2>ğŸ§‘â€ğŸ³ Ù¾Ù†Ù„ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</h2>
        <p>ÙˆØ±ÙˆØ¯ ØºØ±ÙÙ‡â€ŒØ¯Ø§Ø±ØŒ Ø«Ø¨Øª ÙØ±ÙˆØ´ Ù†Ù‚Ø¯ÛŒ ÛŒØ§ Ù†Ø³ÛŒÙ‡ØŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±ÙˆØ²</p>
      </div>
      <div class="card clickable" onclick="showPanel('adminLoginPanel')">
        <h2>ğŸ‘¨â€ğŸ’¼ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
        <p>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ù„ÛŒØŒ Ø¢Ù…Ø§Ø± ØºØ±ÙÙ‡â€ŒÙ‡Ø§ØŒ Ø±ØµØ¯ Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù† Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ</p>
      </div>
    </section>

    <section id="stallLoginPanel" class="card panel">
      <h2>ğŸ§‘â€ğŸ³ ÙˆØ±ÙˆØ¯ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</h2>
      <form onsubmit="stallLogin(event)">
        <div class="form-group">
          <label>Ú©Ø¯ ØºØ±ÙÙ‡</label>
          <input type="text" id="stallCode" placeholder="Ù…Ø«Ø§Ù„: FOOD1" required>
        </div>
        <div class="form-group">
          <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
          <input type="password" id="stallPassword" placeholder="Ø±Ù…Ø² ØºØ±ÙÙ‡" required>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" type="submit">ÙˆØ±ÙˆØ¯</button>
          <button class="btn ghost" type="button" onclick="showPanel('entryScreen')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
      </form>
      <div style="margin-top:18px; font-size:0.9rem; color:#cbd5f5;">
        Ù†Ù…ÙˆÙ†Ù‡: FOOD1/food123 â€“ DRINK1/drink123 â€“ GAME1/game123
      </div>
    </section>

    <section id="adminLoginPanel" class="card panel">
      <h2>ğŸ‘¨â€ğŸ’¼ ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</h2>
      <form onsubmit="adminLogin(event)">
        <div class="form-group">
          <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
          <input type="password" id="adminPassword" placeholder="admin123" required>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" type="submit">ÙˆØ±ÙˆØ¯</button>
          <button class="btn ghost" type="button" onclick="showPanel('entryScreen')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>
      </form>
    </section>

    <section id="stallPanel" class="panel">
      <div class="card" style="margin-bottom:18px; display:flex; flex-wrap:wrap; gap:16px; align-items:center;">
        <div>
          <h2 id="stallWelcome">ğŸ§‘â€ğŸ³ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
          <p id="stallInfo" style="color:#cbd5f5; margin:4px 0 0;"></p>
        </div>
        <div style="margin-inline-start:auto; display:flex; gap:10px;">
          <button class="btn ghost" onclick="refreshStallData()">ğŸ”„ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
          <button class="btn danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3>ğŸ“ Ø«Ø¨Øª ÙØ±ÙˆØ´</h3>
          <div class="form-group">
            <label>Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</label>
            <input type="text" id="studentSearch" placeholder="Ù†Ø§Ù…ØŒ Ú©Ø¯ ÛŒØ§ Ú©Ù„Ø§Ø³..." oninput="debouncedSearchStudent()">
            <div id="searchResults" class="search-results"></div>
          </div>
          <div class="form-group">
            <label>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</label>
            <input type="text" id="selectedStudent" readonly placeholder="Ø§Ø¨ØªØ¯Ø§ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯">
          </div>
          <div class="form-group">
            <label>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
            <input type="number" id="saleAmount" min="1000" step="500">
          </div>
          <div class="form-group">
            <label>Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª</label>
            <select id="paymentType">
              <option value="Ù†Ù‚Ø¯">ğŸ’° Ù†Ù‚Ø¯</option>
              <option value="Ù†Ø³ÛŒÙ‡">ğŸ“ Ù†Ø³ÛŒÙ‡</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ø´Ø±Ø­ Ø§Ù‚Ù„Ø§Ù…</label>
            <textarea id="saleDescription" placeholder="Ù…Ø«Ø§Ù„: Ù¾ÛŒØªØ²Ø§ØŒ Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ..."></textarea>
          </div>
          <button class="btn success" type="button" onclick="submitSale()">Ø«Ø¨Øª ÙØ±ÙˆØ´</button>
        </div>

        <div class="card">
          <h3>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ ØºØ±ÙÙ‡</h3>
          <div id="stallStats" class="stats-grid"></div>
        </div>
      </div>

      <div class="card" style="margin-top:20px;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
          <h3 style="margin:0;">ğŸ“… ÙØ±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</h3>
          <button class="btn ghost" type="button" onclick="loadStallSales()">ğŸ”ƒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
        </div>
        <div id="stallSalesTable" class="table-wrap"></div>
      </div>
    </section>

    <section id="adminPanel" class="panel">
      <div class="card" style="margin-bottom:18px; display:flex; align-items:center; gap:16px;">
        <div>
          <h2>ğŸ‘¨â€ğŸ’¼ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
          <p style="color:#cbd5f5; margin:4px 0 0;">Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø§Ø² ÙØ±ÙˆØ´ØŒ Ø¨Ø¯Ù‡ÛŒ Ùˆ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</p>
        </div>
        <div style="margin-inline-start:auto; display:flex; gap:10px;">
          <button class="btn ghost" onclick="loadAdminStats()">ğŸ”„ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
          <button class="btn danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div class="card">
        <div id="adminStats" class="stats-grid"></div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="stallStatsTab" onclick="showAdminTab('stallStatsTab')">ğŸ“ˆ Ø¢Ù…Ø§Ø± ØºØ±ÙÙ‡â€ŒÙ‡Ø§</button>
        <button class="tab-btn" data-tab="debtorsTab" onclick="showAdminTab('debtorsTab')">ğŸ’³ Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù†</button>
        <button class="tab-btn" data-tab="allSalesTab" onclick="showAdminTab('allSalesTab')">ğŸ“Š Ú©Ù„ ÙØ±ÙˆØ´â€ŒÙ‡Ø§</button>
        <button class="tab-btn" data-tab="uploadTab" onclick="showAdminTab('uploadTab')">ğŸ“¥ Ø¢Ù¾Ù„ÙˆØ¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</button>
      </div>

      <div id="stallStatsTab" class="card admin-tab" style="margin-top:18px;">
        <h3>Ø¢Ù…Ø§Ø± ÙØ±ÙˆØ´ ØºØ±ÙÙ‡â€ŒÙ‡Ø§</h3>
        <div id="adminStallStats"></div>
      </div>

      <div id="debtorsTab" class="card admin-tab" style="margin-top:18px; display:none;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
          <h3 style="margin:0;">Ù„ÛŒØ³Øª Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù†</h3>
          <button class="btn success" onclick="downloadDebtorsExcel()">Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel</button>
        </div>
        <div id="debtorsTable" class="table-wrap"></div>
      </div>

      <div id="allSalesTab" class="card admin-tab" style="margin-top:18px; display:none;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
          <h3 style="margin:0;">ØªÙ…Ø§Ù… ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
          <button class="btn success" onclick="downloadAllSalesExcel()">Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel</button>
        </div>
        <div id="allSalesTable" class="table-wrap"></div>
      </div>

      <div id="uploadTab" class="card admin-tab" style="margin-top:18px; display:none;">
        <h3>Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</h3>
        <p style="color:#cbd5f5; margin-bottom:10px;">ÙØ§ÛŒÙ„ Excel Ø¨Ø§ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ: Ú©Ø¯ | Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ | Ú©Ù„Ø§Ø³</p>
        <input type="file" id="studentsFile" accept=".xlsx,.xls" onchange="handleStudentsUpload(event)">
      </div>
    </section>
  </div>

  <div id="toastContainer" class="toast-container"></div>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbykM014YViKgCLDjSWO1no296TbTzmHR5CkPtu9A9w3BBVeat2xGx_vD3IBAmOjuCAuHg/exec';

    const state = {
      stall: null,
      selectedStudent: null,
      debounceTimer: null,
      debtors: [],
      allSales: []
    };

    const toastContainer = document.getElementById('toastContainer');

    function showPanel(id) {
      document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(panel => panel.style.display = 'none');
      const target = document.getElementById(id);
      if (target) {
        target.style.display = ['entryScreen'].includes(id) ? '' : 'block';
        requestAnimationFrame(() => target.classList.add('active'));
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }

    async function apiRequest(payload) {
      try {
        const formData = new URLSearchParams(payload); // Ø¨Ù‡â€ŒØ¬Ø§ÛŒ JSON
    
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData    // Ø¯ÛŒÚ¯Ù‡ header Ù†Ø°Ø§Ø±
        });
    
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      } catch (err) {
        console.error(err);
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        return { success: false };
      }
    }


    async function stallLogin(e) {
      e.preventDefault();
      const code = document.getElementById('stallCode').value.trim();
      const password = document.getElementById('stallPassword').value.trim();

      const res = await apiRequest({ type: 'stallLogin', code, password });
      if (res.success) {
        state.stall = res.stall;
        document.getElementById('stallWelcome').textContent = `ğŸ§‘â€ğŸ³ ${res.stall.name}`;
        document.getElementById('stallInfo').textContent = `Ú©Ø¯ ØºØ±ÙÙ‡: ${res.stall.code}`;
        showPanel('stallPanel');
        await refreshStallData();
        showToast('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯');
      } else {
        showToast(res.message || 'ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯', 'error');
      }
    }

    async function adminLogin(e) {
      e.preventDefault();
      const password = document.getElementById('adminPassword').value.trim();
      const res = await apiRequest({ type: 'adminLogin', password });
      if (res.success) {
        showPanel('adminPanel');
        loadAdminStats();
        showAdminTab('stallStatsTab');
        showToast('ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ± Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
      } else {
        showToast(res.message || 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', 'error');
      }
    }

    function debouncedSearchStudent() {
      clearTimeout(state.debounceTimer);
      state.debounceTimer = setTimeout(searchStudent, 350);
    }

    async function searchStudent() {
      const query = document.getElementById('studentSearch').value.trim();
      const resultsBox = document.getElementById('searchResults');
      if (query.length < 2) {
        resultsBox.style.display = 'none';
        return;
      }

      const res = await apiRequest({ type: 'searchStudent', query });
      if (!res.success) return;

      if (!res.students.length) {
        resultsBox.innerHTML = '<div class="search-item">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
      } else {
        resultsBox.innerHTML = res.students.map(
          s => `<div class="search-item" onclick="selectStudent('${s.code}', '${s.name}', '${s.class}')">
                  <strong>${s.name}</strong> | ${s.class} | ${s.code}
                </div>`
        ).join('');
      }
      resultsBox.style.display = 'block';
    }

    function selectStudent(code, name, klass) {
      state.selectedStudent = { code, name, class: klass };
      document.getElementById('selectedStudent').value = `${name} - ${klass} (${code})`;
      document.getElementById('studentSearch').value = '';
      document.getElementById('searchResults').style.display = 'none';
    }

    async function submitSale() {
      if (!state.stall) return;
      if (!state.selectedStudent) {
        showToast('Ù„Ø·ÙØ§Ù‹ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }
      const amount = Number(document.getElementById('saleAmount').value);
      const paymentType = document.getElementById('paymentType').value;
      const description = document.getElementById('saleDescription').value.trim();

      if (!amount || amount <= 0 || !description) {
        showToast('Ù…Ø¨Ù„Øº Ùˆ Ø´Ø±Ø­ Ø§Ù„Ø²Ø§Ù…ÛŒ Ù‡Ø³ØªÙ†Ø¯', 'error');
        return;
      }

      const res = await apiRequest({
        type: 'submitSale',
        studentCode: state.selectedStudent.code,
        studentName: state.selectedStudent.name,
        stallName: state.stall.name,
        stallCode: state.stall.code,
        amount,
        paymentType,
        description
      });

      if (res.success) {
        showToast('ÙØ±ÙˆØ´ Ø«Ø¨Øª Ø´Ø¯');
        document.getElementById('saleAmount').value = '';
        document.getElementById('saleDescription').value = '';
        document.getElementById('selectedStudent').value = '';
        state.selectedStudent = null;
        await refreshStallData();
      } else {
        showToast(res.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ÙØ±ÙˆØ´', 'error');
      }
    }

    async function refreshStallData() {
      await Promise.all([loadStallReport(), loadStallSales()]);
    }

    async function loadStallReport() {
      if (!state.stall) return;
      const res = await apiRequest({ type: 'getStallReport', stallName: state.stall.name });
      if (!res.success) return;

      const rpt = res.report;
      const template = [
        { label: 'ÙØ±ÙˆØ´ Ù†Ù‚Ø¯ÛŒ Ú©Ù„', value: rpt.totalCash },
        { label: 'Ø¨Ø¯Ù‡ÛŒ Ú©Ù„', value: rpt.totalDebt },
        { label: 'ÙØ±ÙˆØ´ Ù†Ù‚Ø¯ÛŒ Ø§Ù…Ø±ÙˆØ²', value: rpt.todayCash },
        { label: 'Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²', value: rpt.todayDebt },
        { label: 'ØªØ¹Ø¯Ø§Ø¯ ÙØ±ÙˆØ´ Ù†Ù‚Ø¯ÛŒ', value: rpt.totalCashCount },
        { label: 'ØªØ¹Ø¯Ø§Ø¯ ÙØ±ÙˆØ´ Ù†Ø³ÛŒÙ‡', value: rpt.totalDebtCount }
      ];
      document.getElementById('stallStats').innerHTML = template.map(card => `
        <div class="stat-card">
          <div class="stat-title">${card.label}</div>
          <div class="stat-value">${Number(card.value || 0).toLocaleString('fa-IR')}</div>
        </div>
      `).join('');
    }

    async function loadStallSales() {
      if (!state.stall) return;
      const res = await apiRequest({ type: 'getStallSales', stallName: state.stall.name });
      if (!res.success) return;

      const rows = res.sales.map(sale => `
        <tr>
          <td>${sale.date}</td>
          <td>${sale.time}</td>
          <td>${sale.studentName}</td>
          <td>${Number(sale.amount).toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</td>
          <td>
            <span class="badge ${sale.paymentType === 'Ù†Ù‚Ø¯' ? 'cash' : 'debt'}">
              ${sale.paymentType === 'Ù†Ù‚Ø¯' ? 'ğŸ’° Ù†Ù‚Ø¯' : 'ğŸ“ Ù†Ø³ÛŒÙ‡'}
            </span>
          </td>
          <td>${sale.description}</td>
        </tr>
      `).join('');

      document.getElementById('stallSalesTable').innerHTML = `
        <table>
          <thead>
            <tr><th>ØªØ§Ø±ÛŒØ®</th><th>Ø³Ø§Ø¹Øª</th><th>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</th><th>Ù…Ø¨Ù„Øº</th><th>Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª</th><th>Ø´Ø±Ø­</th></tr>
          </thead>
          <tbody>
            ${rows || '<tr><td colspan="6">ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>'}
          </tbody>
        </table>
      `;
    }

    async function loadAdminStats() {
      const res = await apiRequest({ type: 'getStats' });
      if (!res.success) return;
      const stats = res.stats;
      const cards = [
        { label: 'Ú©Ù„ ÙØ±ÙˆØ´ (ØªÙˆÙ…Ø§Ù†)', value: stats.totalSales },
        { label: 'ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´', value: stats.totalTransactions },
        { label: 'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†', value: stats.totalStudents },
        { label: 'Ú©Ù„ Ø¨Ø¯Ù‡ÛŒ (ØªÙˆÙ…Ø§Ù†)', value: stats.totalDebt }
      ];
      document.getElementById('adminStats').innerHTML = cards.map(card => `
        <div class="stat-card">
          <div class="stat-title">${card.label}</div>
          <div class="stat-value">${Number(card.value || 0).toLocaleString('fa-IR')}</div>
        </div>
      `).join('');
      loadStallStats();
    }

    async function loadStallStats() {
      const res = await apiRequest({ type: 'getStallStats' });
      if (!res.success) return;
      const maxTotal = Math.max(...res.stats.map(s => s.total), 1);
      document.getElementById('adminStallStats').innerHTML = res.stats.map(stat => `
        <div style="margin-bottom:16px;">
          <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
            <strong>${stat.name}</strong>
            <div>${Number(stat.total).toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù† (${stat.transactions} ØªØ±Ø§Ú©Ù†Ø´)</div>
          </div>
          <div style="background:rgba(148,163,184,0.2); height:10px; border-radius:999px; overflow:hidden;">
            <div style="height:100%; width:${(stat.total / maxTotal) * 100}%; background:linear-gradient(90deg,#2563eb,#38bdf8);"></div>
          </div>
        </div>
      `).join('');
    }

    async function loadDebtors() {
      const res = await apiRequest({ type: 'getDebtors' });
      if (!res.success) return;
      state.debtors = res.debtors;
      renderTable('debtorsTable', res.debtors, ['code','name','class','totalDebt','count'], ['Ú©Ø¯','Ù†Ø§Ù…','Ú©Ù„Ø§Ø³','Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¯Ù‡ÛŒ','ØªØ¹Ø¯Ø§Ø¯ Ù†Ø³ÛŒÙ‡'], row => `
        <td>${row.code}</td>
        <td>${row.name}</td>
        <td>${row.class}</td>
        <td>${Number(row.totalDebt).toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</td>
        <td>${row.count}</td>
      `);
    }

    async function loadAllSales() {
      const res = await apiRequest({ type: 'getAllSales' });
      if (!res.success) return;
      state.allSales = res.sales;
      renderTable('allSalesTable', res.sales, [], ['ØªØ§Ø±ÛŒØ®','Ø³Ø§Ø¹Øª','Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²','ØºØ±ÙÙ‡','Ù…Ø¨Ù„Øº','Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª','Ø´Ø±Ø­'], row => `
        <td>${row.date}</td>
        <td>${row.time}</td>
        <td>${row.studentName}</td>
        <td>${row.stallName}</td>
        <td>${Number(row.amount).toLocaleString('fa-IR')} ØªÙˆÙ…Ø§Ù†</td>
        <td>
          <span class="badge ${row.paymentType === 'Ù†Ù‚Ø¯' ? 'cash' : 'debt'}">
            ${row.paymentType === 'Ù†Ù‚Ø¯' ? 'ğŸ’° Ù†Ù‚Ø¯' : 'ğŸ“ Ù†Ø³ÛŒÙ‡'}
          </span>
        </td>
        <td>${row.description}</td>
      `);
    }

    function renderTable(containerId, rows, _, headers, rowTemplate) {
      const body = rows.length
        ? rows.map(rowTemplate).join('')
        : `<tr><td colspan="${headers.length}">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>`;
      document.getElementById(containerId).innerHTML = `
        <table>
          <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
          <tbody>${body}</tbody>
        </table>
      `;
    }

    function showAdminTab(id) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === id));
      document.querySelectorAll('.admin-tab').forEach(tab => tab.style.display = tab.id === id ? 'block' : 'none');
      if (id === 'debtorsTab') loadDebtors();
      if (id === 'allSalesTab') loadAllSales();
    }

    function downloadDebtorsExcel() {
      if (!state.debtors.length) {
        showToast('Ù„ÛŒØ³Øª Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù† Ø®Ø§Ù„ÛŒ Ø§Ø³Øª', 'error');
        return;
      }
      const wb = XLSX.utils.book_new();
      const data = [
        ['Ú©Ø¯', 'Ù†Ø§Ù…', 'Ú©Ù„Ø§Ø³', 'Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¯Ù‡ÛŒ', 'ØªØ¹Ø¯Ø§Ø¯ Ø®Ø±ÛŒØ¯ Ù†Ø³ÛŒÙ‡'],
        ...state.debtors.map(d => [d.code, d.name, d.class, d.totalDebt, d.count])
      ];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'Debtors');
      XLSX.writeFile(wb, `debtors_${new Date().toLocaleDateString('fa-IR')}.xlsx`);
    }

    function downloadAllSalesExcel() {
      if (!state.allSales.length) {
        showToast('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†ÛŒØ³Øª', 'error');
        return;
      }
      const wb = XLSX.utils.book_new();
      const data = [
        ['ØªØ§Ø±ÛŒØ®', 'Ø³Ø§Ø¹Øª', 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²', 'ØºØ±ÙÙ‡', 'Ù…Ø¨Ù„Øº', 'Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª', 'Ø´Ø±Ø­'],
        ...state.allSales.map(s => [s.date, s.time, s.studentName, s.stallName, s.amount, s.paymentType, s.description])
      ];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), 'Sales');
      XLSX.writeFile(wb, `sales_${new Date().toLocaleDateString('fa-IR')}.xlsx`);
    }

    function handleStudentsUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 }).slice(1).filter(r => r[0] && r[1]);
          if (!rows.length) {
            showToast('ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ ÛŒØ§ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', 'error');
            return;
          }
          const res = await apiRequest({ type: 'uploadStudents', students: rows });
          if (res.success) {
            showToast(`${rows.length} Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`);
            loadAdminStats();
          } else {
            showToast(res.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯', 'error');
          }
        } catch (err) {
          console.error(err);
          showToast('Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ø¨Ø§ Ø®Ø·Ø§ Ø±ÙˆØ¨Ù‡â€ŒØ±Ùˆ Ø´Ø¯', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function logout() {
      state.stall = null;
      state.selectedStudent = null;
      document.getElementById('stallCode').value = '';
      document.getElementById('stallPassword').value = '';
      document.getElementById('adminPassword').value = '';
      showPanel('entryScreen');
      showToast('Ø®Ø±ÙˆØ¬ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success');
    }

    document.addEventListener('click', evt => {
      if (!evt.target.closest('.search-results') && evt.target.id !== 'studentSearch') {
        document.getElementById('searchResults').style.display = 'none';
      }
    });

    showPanel('entryScreen');
  </script>
</body>
</html>












