<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ | Ø¯Ø¨ÛŒØ±Ø³ØªØ§Ù† Ø¹Ù„Ø§Ù…Ù‡ Ø­Ù„ÛŒ10</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f59e0b;
      --muted: #94a3b8;
      --bg: #0f172a;
      --card: rgba(15, 23, 42, 0.9);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Vazirmatn', system-ui, sans-serif;
      background: radial-gradient(circle at top, #1d4ed8 0%, #0f172a 55%);
      color: #f8fafc;
      min-height: 100vh;
    }
    a { color: inherit; text-decoration: none; }
    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 20px 60px;
    }
    .hero {
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 24px;
      backdrop-filter: blur(8px);
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    .hero h1 { font-size: 2.4rem; margin-bottom: 8px; }
    .hero p { color: #cbd5f5; margin-bottom: 12px; }
    .hero .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(37,99,235,0.2);
      color: #bfdbfe;
      padding: 6px 18px;
      border-radius: 999px;
      font-size: 0.95rem;
      font-weight: 600;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 15px 45px rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .card.clickable { cursor: pointer; transition: transform 0.25s, border 0.25s; }
    .card.clickable:hover { transform: translateY(-6px); border-color: rgba(37,99,235,0.4); }
    .card h2, .card h3 { margin: 0 0 12px; font-size: 1.4rem; }
    .card p { margin: 0; color: #cbd5f5; line-height: 1.6; }
    .form-group { margin-bottom: 18px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; }
    input, select, textarea {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(15,23,42,0.6);
      color: #fff;
      font-family: inherit;
      font-size: 1rem;
      transition: border 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    textarea { resize: vertical; min-height: 110px; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 22px;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(37,99,235,0.35); }
    .btn.success { background: linear-gradient(135deg, #16a34a, #15803d); }
    .btn.danger { background: linear-gradient(135deg, #dc2626, #b91c1c); }
    .btn.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .btn.small { padding: 8px 16px; font-size: 0.9rem; }
    .panel { display: none; animation: fadeIn 0.4s ease; }
    .panel.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .stat-card {
      background: rgba(15,23,42,0.8);
      border-radius: 16px;
      padding: 18px;
      border: 1px solid rgba(148,163,184,0.2);
    }
    .stat-title { font-size: 0.9rem; color: #cbd5f5; }
    .stat-value { font-size: 1.8rem; font-weight: 700; margin-top: 6px; }
    .table-wrap {
      margin-top: 20px;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.05);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(15,23,42,0.8);
    }
    th, td {
      padding: 12px 16px;
      text-align: center;
    }
    th {
      background: rgba(15,23,42,0.95);
      font-weight: 600;
      color: #bfdbfe;
    }
    tr:nth-child(even) td { background: rgba(15,23,42,0.7); }
    tr:hover td { background: rgba(37,99,235,0.08); }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .badge.cash { background: rgba(22,163,74,0.2); color: #bbf7d0; }
    .badge.debt { background: rgba(220,38,38,0.25); color: #fecdd3; }
    .badge.settled { background: rgba(59,130,246,0.2); color: #bfdbfe; }
    .search-results {
      margin-top: 6px;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      max-height: 220px;
      overflow-y: auto;
      background: rgba(15,23,42,0.95);
      display: none;
    }
    .search-item {
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .search-item:hover { background: rgba(37,99,235,0.12); }
    .tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    .tab-btn {
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: rgba(148,163,184,0.15);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: rgba(37,99,235,0.25);
      border-color: rgba(37,99,235,0.4);
    }
    .toast-container {
      position: fixed;
      inset-inline-start: 20px;
      bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 999;
    }
    .toast {
      min-width: 240px;
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 600;
      color: #fff;
      background: rgba(37,99,235,0.9);
      box-shadow: 0 10px 35px rgba(0,0,0,0.35);
      animation: slideIn 0.3s ease;
    }
    .toast.success { background: rgba(22,163,74,0.9); }
    .toast.error { background: rgba(220,38,38,0.9); }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .debt-item {
      background: rgba(15,23,42,0.6);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(148,163,184,0.2);
    }
    .debt-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .debt-details {
      font-size: 0.9rem;
      color: #cbd5f5;
      line-height: 1.6;
    }
    @media (max-width: 768px) {
      .app-shell { padding: 20px 16px 50px; }
      .hero h1 { font-size: 1.9rem; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="hero">
      <div class="badge">ğŸ“ Ø¯Ø¨ÛŒØ±Ø³ØªØ§Ù† Ø¹Ù„Ø§Ù…Ù‡ Ø­Ù„ÛŒ10 â€“ Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ</div>
      <h1>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ Ø¯Ø§Ù†Ø´ Ø¢Ù…ÙˆØ²ÛŒ</h1>
      <p>Ø«Ø¨Øª ÙØ±ÙˆØ´ØŒ Ú©Ù†ØªØ±Ù„ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ ØºØ±ÙÙ‡â€ŒØ¯Ø§Ø±Ø§Ù†</p>
    </header>

    <section id="entryScreen" class="grid-2 panel active">
      <div class="card clickable" onclick="showPanel('stallLoginPanel')">
        <h2>ğŸ§‘â€ğŸ³ Ù¾Ù†Ù„ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</h2>
        <p>ÙˆØ±ÙˆØ¯ ØºØ±ÙÙ‡â€ŒØ¯Ø§Ø±ØŒ Ø«Ø¨Øª ÙØ±ÙˆØ´ Ù†Ù‚Ø¯ÛŒ ÛŒØ§ Ù†Ø³ÛŒÙ‡ØŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ùˆ ØªØ³ÙˆÛŒÙ‡ Ø¨Ø¯Ù‡ÛŒ</p>
      </div>
      <div class="card clickable" onclick="showPanel('adminLoginPanel')">
        <h2>ğŸ‘¨â€ğŸ’¼ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
        <p>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ù„ÛŒØŒ Ø¢Ù…Ø§Ø± ØºØ±ÙÙ‡â€ŒÙ‡Ø§ØŒ Ø±ØµØ¯ Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù† Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ</p>
      </div>
    </section>

    <section id="stallLoginPanel" class="card panel">
      <h2>ğŸ§‘â€ğŸ³ ÙˆØ±ÙˆØ¯ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</h2>
      <form onsubmit="stallLogin(event)">
        <div class="form-group">
          <label>Ú©Ø¯ ØºØ±ÙÙ‡</label>
          <input type="text" id="stallCode" placeholder="Ù…Ø«Ø§Ù„: FOOD1" required>
        </div>
        <div class="form-group">
          <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
          <input type="password" id="stallPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ØºØ±ÙÙ‡" required>
        </div>
        <button type="submit" class="btn">ÙˆØ±ÙˆØ¯</button>
        <button type="button" class="btn ghost" onclick="showPanel('entryScreen')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <p style="margin-top:12px;font-size:0.9rem;color:#cbd5f5;">Ù†Ù…ÙˆÙ†Ù‡: FOOD1/food123 â€“ DRINK1/drink123 â€“ GAME1/game123</p>
      </form>
    </section>

    <section id="adminLoginPanel" class="card panel">
      <h2>ğŸ‘¨â€ğŸ’¼ ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</h2>
      <form onsubmit="adminLogin(event)">
        <div class="form-group">
          <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
          <input type="password" id="adminPassword" placeholder="Ø±Ù…Ø² Ù…Ø¯ÛŒØ±" required>
        </div>
        <button type="submit" class="btn">ÙˆØ±ÙˆØ¯</button>
        <button type="button" class="btn ghost" onclick="showPanel('entryScreen')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
      </form>
    </section>

    <section id="stallPanel" class="panel">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2>ğŸ§‘â€ğŸ³ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ <span id="boothNameDisplay"></span></h2>
          <div style="display:flex;gap:10px;">
            <button class="btn small" onclick="refreshStallData()">ğŸ”„ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
            <button class="btn small ghost" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>

        <div class="tabs">
          <div class="tab-btn active" onclick="switchStallTab('sale')">ğŸ“ Ø«Ø¨Øª ÙØ±ÙˆØ´</div>
          <div class="tab-btn" onclick="switchStallTab('report')">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ ØºØ±ÙÙ‡</div>
          <div class="tab-btn" onclick="switchStallTab('debts')">ğŸ’³ ØªØ³ÙˆÛŒÙ‡ Ø¨Ø¯Ù‡ÛŒ</div>
        </div>

        <div id="saleTab" class="tab-content" style="margin-top:20px;">
          <h3>ğŸ“ Ø«Ø¨Øª ÙØ±ÙˆØ´</h3>
          <form onsubmit="submitSale(event)">
            <div class="form-group">
              <label>Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</label>
              <input 
                type="text" 
                id="studentSearch" 
                placeholder="Ú©Ø¯ØŒ Ù†Ø§Ù… ÛŒØ§ Ú©Ù„Ø§Ø³" 
                oninput="searchStudents()" 
                autocomplete="off"
              >
              <div id="searchResults" class="search-results"></div>
            </div>
            <div class="form-group">
              <label>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</label>
              <input 
                type="text" 
                id="selectedStudent" 
                readonly 
                placeholder="Ø§Ø¨ØªØ¯Ø§ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯"
              >
              <input type="hidden" id="selectedStudentCode">
            </div>

            <div class="form-group">
              <label>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
              <input type="number" id="amount" placeholder="10000" required>
            </div>
            <div class="form-group">
              <label>Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª</label>
              <select id="paymentType" required>
                <option value="Ù†Ù‚Ø¯">ğŸ’° Ù†Ù‚Ø¯</option>
                <option value="Ù†Ø³ÛŒÙ‡">ğŸ“ Ù†Ø³ÛŒÙ‡</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ø´Ø±Ø­ Ø§Ù‚Ù„Ø§Ù…</label>
              <textarea id="description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø®ØªÛŒØ§Ø±ÛŒ..."></textarea>
            </div>
            <button type="submit" class="btn success">Ø«Ø¨Øª ÙØ±ÙˆØ´</button>
          </form>
        </div>

        <div id="reportTab" class="tab-content" style="display:none;margin-top:20px;">
          <h3>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ ØºØ±ÙÙ‡</h3>
          <div id="boothStatsDisplay" class="stats-grid"></div>
          <h3 style="margin-top:24px;">ğŸ“… ÙØ±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</h3>
          <div id="todaySalesDisplay"></div>
          <button class="btn small" onclick="refreshStallData()" style="margin-top:16px;">ğŸ”ƒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
        </div>

        <div id="debtsTab" class="tab-content" style="display:none;margin-top:20px;">
          <h3>ğŸ’³ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ ØºØ±ÙÙ‡ Ø´Ù…Ø§</h3>
          <div id="boothDebtsDisplay"></div>
          <button class="btn small" onclick="loadBoothDebts()" style="margin-top:16px;">ğŸ”ƒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯</button>
        </div>
      </div>
    </section>

    <section id="adminPanel" class="panel">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2>ğŸ‘¨â€ğŸ’¼ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
          <div style="display:flex;gap:10px;">
            <button class="btn small" onclick="refreshAdminData()">ğŸ”„ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
            <button class="btn small ghost" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>
        <p style="color:#cbd5f5;margin-bottom:24px;">Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø§Ø² ÙØ±ÙˆØ´ØŒ Ø¨Ø¯Ù‡ÛŒ Ùˆ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</p>

        <div class="tabs">
          <div class="tab-btn active" onclick="switchAdminTab('booths')">ğŸ“ˆ Ø¢Ù…Ø§Ø± ØºØ±ÙÙ‡â€ŒÙ‡Ø§</div>
          <div class="tab-btn" onclick="switchAdminTab('debtors')">ğŸ’³ Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù†</div>
          <div class="tab-btn" onclick="switchAdminTab('sales')">ğŸ“Š Ú©Ù„ ÙØ±ÙˆØ´â€ŒÙ‡Ø§</div>
          <div class="tab-btn" onclick="switchAdminTab('upload')">ğŸ“¥ Ø¢Ù¾Ù„ÙˆØ¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</div>
        </div>

        <div id="boothsTab" class="tab-content" style="margin-top:20px;">
          <h3>Ø¢Ù…Ø§Ø± ÙØ±ÙˆØ´ ØºØ±ÙÙ‡â€ŒÙ‡Ø§</h3>
          <div id="boothsStatsDisplay"></div>
        </div>

        <div id="debtorsTab" class="tab-content" style="display:none;margin-top:20px;">
          <h3>Ù„ÛŒØ³Øª Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù†</h3>
          <div id="debtorsDisplay"></div>
          <button class="btn small warning" onclick="downloadDebtorsExcel()" style="margin-top:16px;">Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel</button>
        </div>

        <div id="salesTab" class="tab-content" style="display:none;margin-top:20px;">
          <h3>ØªÙ…Ø§Ù… ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
          <div id="allSalesDisplay"></div>
          <button class="btn small warning" onclick="downloadSalesExcel()" style="margin-top:16px;">Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel</button>
        </div>

        <div id="uploadTab" class="tab-content" style="display:none;margin-top:20px;">
          <h3>Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</h3>
          <p style="color:#cbd5f5;margin-bottom:12px;">ÙØ§ÛŒÙ„ Excel Ø¨Ø§ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ: Ú©Ø¯ | Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ | Ú©Ù„Ø§Ø³</p>
          <input type="file" id="studentsFile" accept=".xlsx,.xls" style="margin-bottom:16px;">
          <button class="btn success" onclick="uploadStudentsFile()">ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯</button>
        </div>
      </div>
    </section>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzHKy7wS_SAcHZAh1cLpXcRSsaJCquCKX-1VjuPzSNKUBvrzljggXfxjhdMXfa5IMEE1w/exec';
    
    let currentBoothCode = '';
    let currentBoothName = '';
    let allStudents = [];
    
    function showPanel(panelId) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.getElementById(panelId).classList.add('active');
    }
  
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }
  
    // âœ… ØªØ§Ø¨Ø¹ apiCall Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡
    async function apiCall(action, data = {}) {
      try {
        const formData = new FormData();
        formData.append('action', action);
        
        Object.keys(data).forEach(key => {
          if (data[key] !== null && data[key] !== undefined) {
            formData.append(key, data[key]);
          }
        });
        
        const response = await fetch(API_URL, {
          method: 'POST',
          body: formData
        });
        
        return await response.json();
      } catch (error) {
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±', 'error');
        throw error;
      }
    }
  
    async function stallLogin() {
      const username = document.getElementById('stall-username').value;
      const password = document.getElementById('stall-password').value;
      
      const response = await apiCall('login', {
        username: username,
        password: password,
        role: 'vendor'
      });
      
      if (response.success) {
        // âœ… Ø­Ø°Ù data
        currentVendor = {
          code: response.vendorCode,    // Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
          name: response.vendorName     // Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
        };
        
        showScreen('stall-panel');
        updateVendorName();
        loadBoothReport();
      } else {
        alert(response.message);
      }
}

  
    async function adminLogin(e) {
      e.preventDefault();
      const password = document.getElementById('adminPassword').value;
  
      const result = await apiCall('login', {
        username: 'admin',
        password: password,
        role: 'admin'
      });
      
      if (result.success) {
        showPanel('adminPanel');
        refreshAdminData();
        showToast('ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ± Ù…ÙˆÙÙ‚');
      } else {
        showToast(result.message, 'error');
      }
    }

    function logout() {
      currentBoothCode = '';
      currentBoothName = '';
      document.querySelectorAll('form').forEach(f => f.reset());
      showPanel('entryScreen');
      showToast('Ø®Ø±ÙˆØ¬ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
    }

    function switchStallTab(tab) {
      document.querySelectorAll('#stallPanel .tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#stallPanel .tab-content').forEach(c => c.style.display = 'none');
      
      event.target.classList.add('active');
      
      if (tab === 'sale') {
        document.getElementById('saleTab').style.display = 'block';
      } else if (tab === 'report') {
        document.getElementById('reportTab').style.display = 'block';
        refreshStallData();
      } else if (tab === 'debts') {
        document.getElementById('debtsTab').style.display = 'block';
        loadBoothDebts();
      }
    }

    function switchAdminTab(tab) {
      document.querySelectorAll('#adminPanel .tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('#adminPanel .tab-content').forEach(c => c.style.display = 'none');
      
      event.target.classList.add('active');
      
      if (tab === 'booths') {
        document.getElementById('boothsTab').style.display = 'block';
      } else if (tab === 'debtors') {
        document.getElementById('debtorsTab').style.display = 'block';
        loadDebtors();
      } else if (tab === 'sales') {
        document.getElementById('salesTab').style.display = 'block';
        loadAllSales();
      } else if (tab === 'upload') {
        document.getElementById('uploadTab').style.display = 'block';
      }
    }

    let searchTimeout;
    async function searchStudents() {
      clearTimeout(searchTimeout);
      const query = document.getElementById('studentSearch').value.trim();
      const resultsDiv = document.getElementById('searchResults');

      if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
      }

      searchTimeout = setTimeout(async () => {
        const result = await apiCall('searchStudent', { query });
        
        if (result.success && result.students.length > 0) {
          resultsDiv.innerHTML = result.students.map(s => `
            <div class="search-item" onclick="selectStudent('${s.code}', '${s.name}', '${s.class}')">
              <strong>${s.name}</strong> | Ú©Ø¯: ${s.code} | ${s.class}
            </div>
          `).join('');
          resultsDiv.style.display = 'block';
        } else {
          resultsDiv.innerHTML = '<div class="search-item">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
          resultsDiv.style.display = 'block';
        }
      }, 300);
    }

    function selectStudent(code, name, className) {
      document.getElementById('selectedStudentCode').value = code;
      document.getElementById('selectedStudent').value = `${name} | ${className}`;
      document.getElementById('searchResults').style.display = 'none';
      document.getElementById('studentSearch').value = '';
    }

    async function submitSale(e) {
      e.preventDefault();
      
      const studentCode = document.getElementById('selectedStudentCode').value;
      if (!studentCode) {
        showToast('Ù„Ø·ÙØ§Ù‹ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }

      const data = {
        boothCode: currentBoothCode,
        studentCode,
        amount: document.getElementById('amount').value,
        paymentType: document.getElementById('paymentType').value,
        description: document.getElementById('description').value
      };

      const result = await apiCall('submitSale', data);
      
      if (result.success) {
        showToast('âœ… ÙØ±ÙˆØ´ Ø«Ø¨Øª Ø´Ø¯');
        document.querySelector('#saleTab form').reset();
        document.getElementById('selectedStudentCode').value = '';
        refreshStallData();
      } else {
        showToast(result.message, 'error');
      }
    }

    async function refreshStallData() {
      const reportResult = await apiCall('getBoothReport', { boothCode: currentBoothCode });
      const salesResult = await apiCall('getBoothSales', { boothCode: currentBoothCode });

      if (reportResult.success) {
        document.getElementById('boothStatsDisplay').innerHTML = `
          <div class="stat-card">
            <div class="stat-title">ğŸ’° ÙØ±ÙˆØ´ Ù†Ù‚Ø¯ÛŒ</div>
            <div class="stat-value">${reportResult.totalCash.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">ğŸ“ ÙØ±ÙˆØ´ Ù†Ø³ÛŒÙ‡</div>
            <div class="stat-value">${reportResult.totalCredit.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">ğŸ’³ Ø¨Ø¯Ù‡ÛŒ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡</div>
            <div class="stat-value">${reportResult.pendingDebt.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
          </div>
          <div class="stat-card">
            <div class="stat-title">ğŸ“Š Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„</div>
            <div class="stat-value">${reportResult.totalAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
          </div>
        `;
      }

      if (salesResult.success) {
        if (salesResult.sales.length === 0) {
          document.getElementById('todaySalesDisplay').innerHTML = '<p style="color:#cbd5f5;margin-top:12px;">Ù‡ÛŒÚ† ÙØ±ÙˆØ´ÛŒ Ø§Ù…Ø±ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
        } else {
          document.getElementById('todaySalesDisplay').innerHTML = `
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Ø³Ø§Ø¹Øª</th>
                    <th>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</th>
                    <th>Ú©Ù„Ø§Ø³</th>
                    <th>Ù…Ø¨Ù„Øº</th>
                    <th>Ù†ÙˆØ¹</th>
                    <th>ÙˆØ¶Ø¹ÛŒØª</th>
                    <th>Ø´Ø±Ø­</th>
                  </tr>
                </thead>
                <tbody>
                  ${salesResult.sales.map(s => `
                    <tr>
                      <td>${s.time}</td>
                      <td>${s.studentName}</td>
                      <td>${s.class}</td>
                      <td>${parseInt(s.amount).toLocaleString()}</td>
                      <td><span class="badge ${s.paymentType === 'Ù†Ù‚Ø¯' ? 'cash' : 'debt'}">${s.paymentType}</span></td>
                      <td><span class="badge ${s.status === 'Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡' ? 'settled' : 'debt'}">${s.status}</span></td>
                      <td>${s.description || '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
      }
    }

    async function loadBoothDebts() {
      const result = await apiCall('getBoothDebts', { boothCode: currentBoothCode });
      
      if (result.success) {
        if (result.debts.length === 0) {
          document.getElementById('boothDebtsDisplay').innerHTML = '<p style="color:#cbd5f5;margin-top:12px;">Ù‡ÛŒÚ† Ø¨Ø¯Ù‡ÛŒ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ØºØ±ÙÙ‡ Ø´Ù…Ø§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ ğŸ‰</p>';
        } else {
          document.getElementById('boothDebtsDisplay').innerHTML = result.debts.map(d => `
            <div class="debt-item">
              <div class="debt-item-header">
                <div>
                  <strong>${d.studentName}</strong> | Ú©Ù„Ø§Ø³: ${d.class}
                </div>
                <button class="btn small success" onclick="settleDebt(${d.rowIndex})">ØªØ³ÙˆÛŒÙ‡</button>
              </div>
              <div class="debt-details">
                ğŸ“… ØªØ§Ø±ÛŒØ®: ${d.date}<br>
                ğŸ’° Ù…Ø¨Ù„Øº: ${parseInt(d.amount).toLocaleString()} ØªÙˆÙ…Ø§Ù†<br>
                ğŸ“ Ø´Ø±Ø­: ${d.description || 'Ù†Ø¯Ø§Ø±Ø¯'}
              </div>
            </div>
          `).join('');
        }
      }
    }

    async function settleDebt(rowIndex) {
      if (!confirm('Ø¢ÛŒØ§ Ø§Ø² ØªØ³ÙˆÛŒÙ‡ Ø§ÛŒÙ† Ø¨Ø¯Ù‡ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return;

      const result = await apiCall('settleDebt', { rowIndex });
      
      if (result.success) {
        showToast('âœ… Ø¨Ø¯Ù‡ÛŒ ØªØ³ÙˆÛŒÙ‡ Ø´Ø¯');
        loadBoothDebts();
        refreshStallData();
      } else {
        showToast(result.message, 'error');
      }
    }

    async function refreshAdminData() {
      const dashResult = await apiCall('getDashboard');
      
      if (dashResult.success) {
        const booths = dashResult.booths;
        
        if (booths.length === 0) {
          document.getElementById('boothsStatsDisplay').innerHTML = '<p style="color:#cbd5f5;margin-top:12px;">Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>';
        } else {
          document.getElementById('boothsStatsDisplay').innerHTML = `
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>ØºØ±ÙÙ‡</th>
                    <th>ğŸ’° Ù†Ù‚Ø¯</th>
                    <th>ğŸ“ Ù†Ø³ÛŒÙ‡</th>
                    <th>ğŸ’³ Ø¨Ø¯Ù‡ÛŒ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡</th>
                    <th>ğŸ“Š Ù…Ø¬Ù…ÙˆØ¹</th>
                  </tr>
                </thead>
                <tbody>
                  ${booths.map(b => `
                    <tr>
                      <td><strong>${b.name}</strong></td>
                      <td>${b.totalCash.toLocaleString()}</td>
                      <td>${b.totalCredit.toLocaleString()}</td>
                      <td>${b.pendingDebt.toLocaleString()}</td>
                      <td><strong>${b.totalAmount.toLocaleString()}</strong></td>
                    </tr>
                  `).join('')}
                  <tr style="background:rgba(37,99,235,0.15);font-weight:700;">
                    <td>ğŸ¯ Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„</td>
                    <td>${booths.reduce((s,b)=>s+b.totalCash,0).toLocaleString()}</td>
                    <td>${booths.reduce((s,b)=>s+b.totalCredit,0).toLocaleString()}</td>
                    <td>${booths.reduce((s,b)=>s+b.pendingDebt,0).toLocaleString()}</td>
                    <td>${booths.reduce((s,b)=>s+b.totalAmount,0).toLocaleString()}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          `;
        }
      }
    }

    async function loadDebtors() {
      const result = await apiCall('getDebtors');
      
      if (result.success) {
        if (result.debtors.length === 0) {
          document.getElementById('debtorsDisplay').innerHTML = '<p style="color:#cbd5f5;margin-top:12px;">Ù‡ÛŒÚ† Ø¨Ø¯Ù‡Ú©Ø§Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ ğŸ‰</p>';
        } else {
          document.getElementById('debtorsDisplay').innerHTML = `
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</th>
                    <th>Ú©Ù„Ø§Ø³</th>
                    <th>ØºØ±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¯Ù‡Ú©Ø§Ø±</th>
                    <th>ğŸ’° Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¯Ù‡ÛŒ</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.debtors.map(d => `
                    <tr>
                      <td><strong>${d.studentName}</strong></td>
                      <td>${d.class}</td>
                      <td>${d.booths}</td>
                      <td><span class="badge debt">${d.totalDebt.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span></td>
                    </tr>
                  `).join('')}
                  <tr style="background:rgba(220,38,38,0.15);font-weight:700;">
                    <td colspan="3">ğŸ¯ Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ø¨Ø¯Ù‡ÛŒ</td>
                    <td>${result.debtors.reduce((s,d)=>s+d.totalDebt,0).toLocaleString()} ØªÙˆÙ…Ø§Ù†</td>
                  </tr>
                </tbody>
              </table>
            </div>
          `;
        }
      }
    }

    async function loadAllSales() {
      const result = await apiCall('getAllSales');
      
      if (result.success) {
        if (result.sales.length === 0) {
          document.getElementById('allSalesDisplay').innerHTML = '<p style="color:#cbd5f5;margin-top:12px;">Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
        } else {
          document.getElementById('allSalesDisplay').innerHTML = `
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>ØªØ§Ø±ÛŒØ®</th>
                    <th>Ø³Ø§Ø¹Øª</th>
                    <th>ØºØ±ÙÙ‡</th>
                    <th>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</th>
                    <th>Ú©Ù„Ø§Ø³</th>
                    <th>Ù…Ø¨Ù„Øº</th>
                    <th>Ù†ÙˆØ¹</th>
                    <th>ÙˆØ¶Ø¹ÛŒØª</th>
                    <th>ØªØ§Ø±ÛŒØ® ØªØ³ÙˆÛŒÙ‡</th>
                  </tr>
                </thead>
                <tbody>
                  ${result.sales.map(s => `
                    <tr>
                      <td>${s.date}</td>
                      <td>${s.time}</td>
                      <td>${s.boothName}</td>
                      <td>${s.studentName}</td>
                      <td>${s.class}</td>
                      <td>${parseInt(s.amount).toLocaleString()}</td>
                      <td><span class="badge ${s.paymentType === 'Ù†Ù‚Ø¯' ? 'cash' : 'debt'}">${s.paymentType}</span></td>
                      <td><span class="badge ${s.status === 'Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡' ? 'settled' : 'debt'}">${s.status}</span></td>
                      <td>${s.settlementDate || '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
      }
    }

    async function downloadDebtorsExcel() {
      const result = await apiCall('getDebtors');
      
      if (!result.success || result.debtors.length === 0) {
        showToast('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'error');
        return;
      }

      const data = result.debtors.map(d => ({
        'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²': d.studentName,
        'Ú©Ù„Ø§Ø³': d.class,
        'ØºØ±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¯Ù‡Ú©Ø§Ø±': d.booths,
        'Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¯Ù‡ÛŒ': d.totalDebt
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù†');
      XLSX.writeFile(wb, `debtors_${new Date().toISOString().split('T')[0]}.xlsx`);
      showToast('âœ… ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
    }

    async function downloadSalesExcel() {
      const result = await apiCall('getAllSales');
      
      if (!result.success || result.sales.length === 0) {
        showToast('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'error');
        return;
      }

      const data = result.sales.map(s => ({
        'ØªØ§Ø±ÛŒØ®': s.date,
        'Ø³Ø§Ø¹Øª': s.time,
        'ØºØ±ÙÙ‡': s.boothName,
        'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²': s.studentName,
        'Ú©Ù„Ø§Ø³': s.class,
        'Ù…Ø¨Ù„Øº': s.amount,
        'Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª': s.paymentType,
        'ÙˆØ¶Ø¹ÛŒØª': s.status,
        'ØªØ§Ø±ÛŒØ® ØªØ³ÙˆÛŒÙ‡': s.settlementDate || '',
        'Ø´Ø±Ø­': s.description
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'ÙØ±ÙˆØ´â€ŒÙ‡Ø§');
      XLSX.writeFile(wb, `sales_${new Date().toISOString().split('T')[0]}.xlsx`);
      showToast('âœ… ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
    }

    async function uploadStudentsFile() {
      const fileInput = document.getElementById('studentsFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showToast('Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          if (jsonData.length < 2) {
            showToast('ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª', 'error');
            return;
          }

          const students = jsonData.slice(1).map(row => ({
            code: String(row[0] || '').trim(),
            name: String(row[1] || '').trim(),
            class: String(row[2] || '').trim()
          })).filter(s => s.code && s.name && s.class);

          if (students.length === 0) {
            showToast('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
            return;
          }

          const result = await apiCall('uploadStudents', { students });
          
          if (result.success) {
            showToast(`âœ… ${students.length} Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯`);
            fileInput.value = '';
          } else {
            showToast(result.message, 'error');
          }
        } catch (error) {
          showToast('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>





