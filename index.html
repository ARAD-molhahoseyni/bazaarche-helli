<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ Ø¹Ù„Ø§Ù…Ù‡ Ø­Ù„ÛŒ Ø¯Ù‡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazir', Tahoma, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            padding: 40px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .logo {
            text-align: center;
            font-size: 60px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .quick-pay {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .quick-btn {
            padding: 15px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            background: #667eea;
            color: white;
        }

        .transactions {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .transaction {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-right: 4px solid #667eea;
        }

        .transaction.purchase {
            border-right-color: #ff6b6b;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .transaction-details {
            font-size: 12px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .success {
            background: #efe;
            color: #060;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .back-btn {
            background: none;
            border: 2px solid #667eea;
            color: #667eea;
            width: auto;
            padding: 10px 20px;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- ØµÙØ­Ù‡ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ -->
    <div id="welcomePage" class="page active">
        <div class="logo">ğŸª</div>
        <h1>Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ Ø¹Ù„Ø§Ù…Ù‡ Ø­Ù„ÛŒ Ø¯Ù‡</h1>
        <p class="subtitle">Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</p>
        
        <div id="syncStatus" class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...</div>
        
        <button class="btn" onclick="showPage('registerPage')">âœ¨ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
        <button class="btn btn-secondary" onclick="showPage('loginPage')">ğŸ” ÙˆØ±ÙˆØ¯</button>
        <button class="btn btn-success" onclick="showPage('adminPage')">ğŸ‘¨â€ğŸ’¼ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</button>
        <button class="btn btn-warning" onclick="syncData()">ğŸ”„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Ø³Ø±ÙˆØ±</button>
    </div>

    <!-- ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… -->
    <div id="registerPage" class="page">
        <button class="btn back-btn" onclick="showPage('welcomePage')">â† Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h1>Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</h1>
        <p class="subtitle">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
        
        <div id="registerMessage"></div>
        
        <div class="input-group">
            <label>ğŸ‘¤ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</label>
            <input type="text" id="regName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ">
        </div>
        
        <div class="input-group">
            <label>ğŸ« Ú©Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ:</label>
            <input type="text" id="regStudentId" placeholder="Ù…Ø«Ø§Ù„: 1001">
        </div>
        
        <button class="btn" onclick="registerStudent()">âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
    </div>

    <!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ -->
    <div id="loginPage" class="page">
        <button class="btn back-btn" onclick="showPage('welcomePage')">â† Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h1>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</h1>
        <p class="subtitle">Ø¨Ø§ Ú©Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø®ÙˆØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</p>
        
        <div id="loginMessage"></div>
        
        <div class="input-group">
            <label>ğŸ‘¤ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</label>
            <input type="text" id="loginName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ">
        </div>
        
        <div class="input-group">
            <label>ğŸ« Ú©Ø¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ:</label>
            <input type="text" id="loginStudentId" placeholder="Ù…Ø«Ø§Ù„: 1001">
        </div>
        
        <button class="btn" onclick="loginStudent()">ğŸš€ ÙˆØ±ÙˆØ¯</button>
    </div>

    <!-- ØµÙØ­Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„ -->
    <div id="walletPage" class="page">
        <button class="btn back-btn" onclick="logout()">â† Ø®Ø±ÙˆØ¬</button>
        <h1>Ú©ÛŒÙ Ù¾ÙˆÙ„</h1>
        <p class="subtitle" id="walletUser"></p>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="balance">0</div>
                <div class="stat-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ (ØªÙˆÙ…Ø§Ù†)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalPurchases">0</div>
                <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ Ø®Ø±ÛŒØ¯Ù‡Ø§</div>
            </div>
        </div>
        
        <h3 style="margin: 20px 0 10px 0;">ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ø³Ø±ÛŒØ¹</h3>
        <div class="quick-pay">
            <button class="quick-btn" onclick="quickPay(1000)">Û±,Û°Û°Û° ØªÙˆÙ…Ø§Ù†</button>
            <button class="quick-btn" onclick="quickPay(2000)">Û²,Û°Û°Û° ØªÙˆÙ…Ø§Ù†</button>
            <button class="quick-btn" onclick="quickPay(5000)">Ûµ,Û°Û°Û° ØªÙˆÙ…Ø§Ù†</button>
            <button class="quick-btn" onclick="quickPay(10000)">Û±Û°,Û°Û°Û° ØªÙˆÙ…Ø§Ù†</button>
        </div>
        
        <div id="purchaseMessage"></div>
        
        <div class="input-group">
            <label>ğŸ’° Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†):</label>
            <input type="number" id="purchaseAmount" placeholder="Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        </div>
        
        <div class="input-group">
            <label>ğŸª ØºØ±ÙÙ‡:</label>
            <select id="purchaseStall">
                <option value="">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>
            </select>
        </div>
        
        <div class="input-group">
            <label>ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
            <textarea id="purchaseDesc" rows="2" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®Ø±ÛŒØ¯..."></textarea>
        </div>
        
        <button class="btn" onclick="makePurchase()">âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ùˆ Ø®Ø±ÛŒØ¯</button>
        
        <h3 style="margin: 30px 0 10px 0;">ğŸ“‹ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
        <div id="transactions" class="transactions"></div>
    </div>

    <!-- ØµÙØ­Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª -->
    <div id="adminPage" class="page">
        <div id="adminLogin">
            <button class="btn back-btn" onclick="showPage('welcomePage')">â† Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            <h1>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h1>
            <p class="subtitle">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ù…Ø¯ÛŒØ±ÛŒØª</p>
            
            <div id="adminLoginMessage"></div>
            
            <div class="input-group">
                <label>ğŸ”‘ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
                <input type="password" id="adminPassword" placeholder="Ø±Ù…Ø² Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
            </div>
            
            <button class="btn" onclick="adminLogin()">ğŸš€ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„</button>
        </div>
        
        <div id="adminDashboard" style="display:none;">
            <button class="btn back-btn" onclick="adminLogout()">â† Ø®Ø±ÙˆØ¬ Ø§Ø² Ù¾Ù†Ù„</button>
            <h1>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª</h1>
            <p class="subtitle">Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ Ø¹Ù„Ø§Ù…Ù‡ Ø­Ù„ÛŒ Ø¯Ù‡</p>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalStalls">0</div>
                    <div class="stat-label">ØºØ±ÙÙ‡â€ŒÙ‡Ø§</div>
                </div>
            </div>
            
            <div id="adminMessage"></div>
            
            <h3 style="margin: 20px 0 10px 0;">âš¡ Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</h3>
            <div class="input-group">
                <label>ğŸ‘¤ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²:</label>
                <select id="chargeStudent">
                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²...</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>ğŸ’° Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜ (ØªÙˆÙ…Ø§Ù†):</label>
                <input type="number" id="chargeAmount" placeholder="Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜">
            </div>
            
            <div class="input-group">
                <label>ğŸ’µ Ù…Ø¨Ù„Øº Ù†Ù‚Ø¯ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ (ØªÙˆÙ…Ø§Ù†):</label>
                <input type="number" id="chargeCash" placeholder="Ù…Ø¨Ù„Øº Ù†Ù‚Ø¯ÛŒ">
            </div>
            
            <button class="btn" onclick="chargeStudent()">âš¡ Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨</button>
            
            <h3 style="margin: 30px 0 10px 0;">â• Ø§ÙØ²ÙˆØ¯Ù† ØºØ±ÙÙ‡ Ø¬Ø¯ÛŒØ¯</h3>
            <div class="input-group">
                <label>ğŸª Ù†Ø§Ù… ØºØ±ÙÙ‡:</label>
                <input type="text" id="stallName" placeholder="Ù…Ø«Ø§Ù„: ØºØ±ÙÙ‡ Ú©ØªØ§Ø¨">
            </div>
            
            <div class="input-group">
                <label>ğŸ« Ú©Ø¯ ØºØ±ÙÙ‡:</label>
                <input type="text" id="stallCode" placeholder="Ù…Ø«Ø§Ù„: BOOK1">
            </div>
            
            <button class="btn btn-success" onclick="addStall()">â• Ø§ÙØ²ÙˆØ¯Ù† ØºØ±ÙÙ‡</button>
            
            <h3 style="margin: 30px 0 10px 0;">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´Ø§Øª</h3>
            <div id="adminReports" class="transactions"></div>
            
            <button class="btn btn-danger" onclick="resetSystem()" style="margin-top: 30px;">ğŸ—‘ï¸ Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…</button>
        </div>
    </div>
</div>

<script>
// ========== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ ==========
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzTPmSoXHk4U6Z-GO8R91f_xWm6iL6hvWIVX8T3fhHzrhP6GJZYbmTyqEKxzl_WUmw9/exec'; // Ø¢Ø¯Ø±Ø³ Apps Script Ú©Ù‡ Ú©Ù¾ÛŒ Ú©Ø±Ø¯ÛŒØ¯
const ADMIN_PASS = '';

let currentUser = null;
let allData = {
    students: [],
    charges: [],
    purchases: [],
    stalls: []
};

// ========== ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ==========
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
}

function showMessage(elementId, message, type = 'error') {
    const el = document.getElementById(elementId);
    el.className = type;
    el.textContent = message;
    setTimeout(() => el.textContent = '', 5000);
}

function formatNumber(num) {
    return new Intl.NumberFormat('fa-IR').format(num);
}

// ========== API Calls ==========
async function callAPI(action, params = {}) {
    try {
        const url = new URL(SCRIPT_URL);
        url.searchParams.append('action', action);
        Object.keys(params).forEach(key => {
            url.searchParams.append(key, params[key]);
        });
        
        const response = await fetch(url);
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('API Error:', error);
        return { success: false, error: 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±' };
    }
}

// ========== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ==========
async function initSystem() {
    const result = await callAPI('init');
    if (result.success) {
        await syncData();
    }
}

async function syncData() {
    document.getElementById('syncStatus').textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...';
    
    const result = await callAPI('getAll');
    if (result.success) {
        allData = result;
        document.getElementById('syncStatus').className = 'success';
        document.getElementById('syncStatus').textContent = 'âœ… Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø§Ø³Øª';
        
        updateAdminData();
    } else {
        document.getElementById('syncStatus').className = 'error';
        document.getElementById('syncStatus').textContent = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„';
    }
}

// ========== Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… ==========
async function registerStudent() {
    const name = document.getElementById('regName').value.trim();
    const studentId = document.getElementById('regStudentId').value.trim();
    
    if (!name || !studentId) {
        showMessage('registerMessage', 'Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
        return;
    }
    
    const result = await callAPI('saveStudent', { name, studentId });
    
    if (result.success) {
        showMessage('registerMessage', 'âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!', 'success');
        await syncData();
        setTimeout(() => showPage('loginPage'), 2000);
    } else {
        showMessage('registerMessage', result.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…');
    }
}

// ========== ÙˆØ±ÙˆØ¯ ==========
async function loginStudent() {
    const name = document.getElementById('loginName').value.trim();
    const studentId = document.getElementById('loginStudentId').value.trim();
    
    if (!name || !studentId) {
        showMessage('loginMessage', 'Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
        return;
    }
    
    await syncData();
    
    const student = allData.students.find(s => 
        s.studentId == studentId && s.name === name
    );
    
    if (student) {
        currentUser = student;
        showWallet();
    } else {
        showMessage('loginMessage', 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª');
    }
}

function logout() {
    currentUser = null;
    showPage('welcomePage');
}

// ========== Ú©ÛŒÙ Ù¾ÙˆÙ„ ==========
async function showWallet() {
    await syncData();
    
    const student = allData.students.find(s => s.studentId == currentUser.studentId);
    if (!student) {
        logout();
        return;
    }
    
    currentUser = student;
    
    document.getElementById('walletUser').textContent = `${currentUser.name} - Ú©Ø¯: ${currentUser.studentId}`;
    document.getElementById('balance').textContent = formatNumber(currentUser.balance || 0);
    
    // ØªØ¹Ø¯Ø§Ø¯ Ø®Ø±ÛŒØ¯Ù‡Ø§
    const userPurchases = allData.purchases.filter(p => p.studentId == currentUser.studentId);
    document.getElementById('totalPurchases').textContent = formatNumber(userPurchases.length);
    
    // ØºØ±ÙÙ‡â€ŒÙ‡Ø§
    const stallSelect = document.getElementById('purchaseStall');
    stallSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ ØºØ±ÙÙ‡...</option>';
    allData.stalls.forEach(stall => {
        const option = document.createElement('option');
        option.value = stall.code;
        option.textContent = stall.name;
        stallSelect.appendChild(option);
    });
    
    // ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
    const transDiv = document.getElementById('transactions');
    transDiv.innerHTML = '';
    
    const userCharges = allData.charges.filter(c => c.studentId == currentUser.studentId);
    const allTransactions = [
        ...userCharges.map(c => ({ ...c, type: 'charge' })),
        ...userPurchases.map(p => ({ ...p, type: 'purchase' }))
    ].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    allTransactions.forEach(t => {
        const div = document.createElement('div');
        div.className = `transaction ${t.type}`;
        div.innerHTML = `
            <div class="transaction-header">
                <span>${t.type === 'charge' ? 'âš¡ Ø´Ø§Ø±Ú˜' : 'ğŸ›’ Ø®Ø±ÛŒØ¯'}</span>
                <span>${formatNumber(t.amount)} ØªÙˆÙ…Ø§Ù†</span>
            </div>
            <div class="transaction-details">
                ${t.type === 'charge' ? 'Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨' : (t.stall + ' - ' + (t.description || 'Ø®Ø±ÛŒØ¯'))}
                <br>
                ${new Date(t.date).toLocaleString('fa-IR')}
            </div>
        `;
        transDiv.appendChild(div);
    });
    
    showPage('walletPage');
}

function quickPay(amount) {
    document.getElementById('purchaseAmount').value = amount;
}

async function makePurchase() {
    const amount = parseInt(document.getElementById('purchaseAmount').value);
    const stall = document.getElementById('purchaseStall').value;
    const description = document.getElementById('purchaseDesc').value.trim();
    
    if (!amount || !stall) {
        showMessage('purchaseMessage', 'Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº Ùˆ ØºØ±ÙÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
        return;
    }
    
    if (amount > currentUser.balance) {
        showMessage('purchaseMessage', 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!');
        return;
    }
    
    const result = await callAPI('savePurchase', {
        studentId: currentUser.studentId,
        amount,
        stall,
        description
    });
    
    if (result.success) {
        showMessage('purchaseMessage', 'âœ… Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!', 'success');
        document.getElementById('purchaseAmount').value = '';
        document.getElementById('purchaseDesc').value = '';
        await showWallet();
    } else {
        showMessage('purchaseMessage', result.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÛŒØ¯');
    }
}

// ========== Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† ==========
function adminLogin() {
    const pass = document.getElementById('adminPassword').value;
    
    if (pass === ADMIN_PASS) {
        document.getElementById('adminLogin').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        updateAdminData();
    } else {
        showMessage('adminLoginMessage', 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
    }
}

function adminLogout() {
    document.getElementById('adminLogin').style.display = 'block';
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('adminPassword').value = '';
    showPage('welcomePage');
}

async function updateAdminData() {
    await syncData();
    
    document.getElementById('totalStudents').textContent = formatNumber(allData.students.length);
    document.getElementById('totalStalls').textContent = formatNumber(allData.stalls.length);
    
    // Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø´Ø§Ø±Ú˜
    const chargeSelect = document.getElementById('chargeStudent');
    chargeSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²...</option>';
    allData.students.forEach(student => {
        const option = document.createElement('option');
        option.value = student.studentId;
        option.textContent = `${student.name} (Ú©Ø¯: ${student.studentId}) - Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${formatNumber(student.balance)} ØªÙˆÙ…Ø§Ù†`;
        chargeSelect.appendChild(option);
    });
    
    // Ú¯Ø²Ø§Ø±Ø´Ø§Øª
    const reportsDiv = document.getElementById('adminReports');
    reportsDiv.innerHTML = '';
    
    allData.charges.slice().reverse().slice(0, 10).forEach(c => {
        const div = document.createElement('div');
        div.className = 'transaction';
        div.innerHTML = `
            <div class="transaction-header">
                <span>âš¡ Ø´Ø§Ø±Ú˜: ${c.name}</span>
                <span>${formatNumber(c.amount)} ØªÙˆÙ…Ø§Ù†</span>
            </div>
            <div class="transaction-details">
                Ù†Ù‚Ø¯ÛŒ: ${formatNumber(c.cash)} ØªÙˆÙ…Ø§Ù†
                <br>
                ${new Date(c.date).toLocaleString('fa-IR')}
            </div>
        `;
        reportsDiv.appendChild(div);
    });
}

async function chargeStudent() {
    const studentId = document.getElementById('chargeStudent').value;
    const amount = parseInt(document.getElementById('chargeAmount').value);
    const cash = parseInt(document.getElementById('chargeCash').value);
    
    if (!studentId || !amount || !cash) {
        showMessage('adminMessage', 'Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
        return;
    }
    
    const result = await callAPI('saveCharge', { studentId, amount, cash });
    
    if (result.success) {
        showMessage('adminMessage', 'âœ… Ø´Ø§Ø±Ú˜ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!', 'success');
        document.getElementById('chargeAmount').value = '';
        document.getElementById('chargeCash').value = '';
        await updateAdminData();
    } else {
        showMessage('adminMessage', result.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø´Ø§Ø±Ú˜');
    }
}

async function addStall() {
    const name = document.getElementById('stallName').value.trim();
    const code = document.getElementById('stallCode').value.trim().toUpperCase();
    
    if (!name || !code) {
        showMessage('adminMessage', 'Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ú©Ø¯ ØºØ±ÙÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
    }
    
    const result = await callAPI('saveStall', { name, code });
    
    if (result.success) {
        showMessage('adminMessage', 'âœ… ØºØ±ÙÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!', 'success');
        document.getElementById('stallName').value = '';
        document.getElementById('stallCode').value = '';
        await updateAdminData();
    } else {
        showMessage('adminMessage', result.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† ØºØ±ÙÙ‡');
    }
}

async function resetSystem() {
    if (!confirm('âš ï¸ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯! Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) return;
    if (!confirm('âš ï¸âš ï¸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª! Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªØ£ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯:')) return;
    
    // Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ§Ø¨Ø¹ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¯Ø± Apps Script Ø¯Ø§Ø±Ø¯
    alert('Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ØŒ Ø§Ø² Google Sheets Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¬Ø¯Ø§ÙˆÙ„ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯.');
}

// ========== Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ ==========
window.onload = async function() {
    await initSystem();
};
</script>

</body>
</html>
Ø²Ø¨
