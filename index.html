<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ | Ø¯Ø¨ÛŒØ±Ø³ØªØ§Ù† Ø¹Ù„Ø§Ù…Ù‡ Ø­Ù„ÛŒ10</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f59e0b;
      --muted: #94a3b8;
      --bg: #0f172a;
      --card: rgba(15, 23, 42, 0.9);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Vazirmatn', system-ui, sans-serif;
      background: radial-gradient(circle at top, #1d4ed8 0%, #0f172a 55%);
      color: #f8fafc;
      min-height: 100vh;
    }
    a { color: inherit; text-decoration: none; }
    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 20px 60px;
    }
    .hero {
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 24px;
      backdrop-filter: blur(8px);
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    .hero h1 { font-size: 2.4rem; margin-bottom: 8px; }
    .hero p { color: #cbd5f5; margin-bottom: 12px; }
    .hero .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(37,99,235,0.2);
      color: #bfdbfe;
      padding: 6px 18px;
      border-radius: 999px;
      font-size: 0.95rem;
      font-weight: 600;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 15px 45px rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .card.clickable { cursor: pointer; transition: transform 0.25s, border 0.25s; }
    .card.clickable:hover { transform: translateY(-6px); border-color: rgba(37,99,235,0.4); }
    .card h2, .card h3 { margin: 0 0 12px; font-size: 1.4rem; }
    .card p { margin: 0; color: #cbd5f5; line-height: 1.6; }
    .form-group { margin-bottom: 18px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; }
    input, select, textarea {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(15,23,42,0.6);
      color: #fff;
      font-family: inherit;
      font-size: 1rem;
      transition: border 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    textarea { resize: vertical; min-height: 110px; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 22px;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(37,99,235,0.35); }
    .btn.success { background: linear-gradient(135deg, #16a34a, #15803d); }
    .btn.danger { background: linear-gradient(135deg, #dc2626, #b91c1c); }
    .btn.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .btn.small { padding: 8px 16px; font-size: 0.9rem; }
    .panel { display: none; animation: fadeIn 0.4s ease; }
    .panel.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .stat-card {
      background: rgba(15,23,42,0.8);
      border-radius: 16px;
      padding: 18px;
      border: 1px solid rgba(148,163,184,0.2);
    }
    .stat-title { font-size: 0.9rem; color: #cbd5f5; }
    .stat-value { font-size: 1.8rem; font-weight: 700; margin-top: 6px; }
    .table-wrap {
      margin-top: 20px;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.05);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(15,23,42,0.8);
    }
    th, td {
      padding: 12px 16px;
      text-align: center;
    }
    th {
      background: rgba(15,23,42,0.95);
      font-weight: 600;
      color: #bfdbfe;
    }
    tr:nth-child(even) td { background: rgba(15,23,42,0.7); }
    tr:hover td { background: rgba(37,99,235,0.08); }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .badge.cash { background: rgba(22,163,74,0.2); color: #bbf7d0; }
    .badge.debt { background: rgba(220,38,38,0.25); color: #fecdd3; }
    .badge.settled { background: rgba(59,130,246,0.2); color: #bfdbfe; }
    .search-results {
      margin-top: 6px;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      max-height: 220px;
      overflow-y: auto;
      background: rgba(15,23,42,0.95);
      display: none;
    }
    .search-item {
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .search-item:hover { background: rgba(37,99,235,0.12); }
    .tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    .tab-btn {
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: rgba(148,163,184,0.15);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: rgba(37,99,235,0.25);
      border-color: rgba(37,99,235,0.4);
    }
    .toast-container {
      position: fixed;
      inset-inline-start: 20px;
      bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 999;
    }
    .toast {
      min-width: 240px;
      padding: 12px 18px;
      border-radius: 12px;
      font-weight: 600;
      color: #fff;
      background: rgba(37,99,235,0.9);
      box-shadow: 0 10px 35px rgba(0,0,0,0.35);
      animation: slideIn 0.3s ease;
    }
    .toast.success { background: rgba(22,163,74,0.9); }
    .toast.error { background: rgba(220,38,38,0.9); }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .debt-item {
      background: rgba(15,23,42,0.6);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(148,163,184,0.2);
    }
    .debt-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .debt-details {
      font-size: 0.9rem;
      color: #cbd5f5;
      line-height: 1.6;
    }
    @media (max-width: 768px) {
      .app-shell { padding: 20px 16px 50px; }
      .hero h1 { font-size: 1.9rem; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="hero">
      <div class="badge">ğŸ“ Ø¯Ø¨ÛŒØ±Ø³ØªØ§Ù† Ø¹Ù„Ø§Ù…Ù‡ Ø­Ù„ÛŒ10 â€“ Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ</div>
      <h1>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§Ø²Ø§Ø±Ú†Ù‡ Ø¯Ø§Ù†Ø´ Ø¢Ù…ÙˆØ²ÛŒ</h1>
      <p>Ø«Ø¨Øª ÙØ±ÙˆØ´ØŒ Ú©Ù†ØªØ±Ù„ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ ØºØ±ÙÙ‡â€ŒØ¯Ø§Ø±Ø§Ù†</p>
    </header>

    <section id="entryScreen" class="grid-2 panel active">
      <div class="card clickable" onclick="showPanel('stallLoginPanel')">
        <h2>ğŸ§‘â€ğŸ³ Ù¾Ù†Ù„ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</h2>
        <p>ÙˆØ±ÙˆØ¯ ØºØ±ÙÙ‡â€ŒØ¯Ø§Ø±ØŒ Ø«Ø¨Øª ÙØ±ÙˆØ´ Ù†Ù‚Ø¯ÛŒ ÛŒØ§ Ù†Ø³ÛŒÙ‡ØŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ùˆ ØªØ³ÙˆÛŒÙ‡ Ø¨Ø¯Ù‡ÛŒ</p>
      </div>
      <div class="card clickable" onclick="showPanel('adminLoginPanel')">
        <h2>ğŸ‘¨â€ğŸ’¼ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
        <p>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ù„ÛŒØŒ Ø¢Ù…Ø§Ø± ØºØ±ÙÙ‡â€ŒÙ‡Ø§ØŒ Ø±ØµØ¯ Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù† Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ</p>
      </div>
    </section>

    <section id="stallLoginPanel" class="card panel">
      <h2>ğŸ§‘â€ğŸ³ ÙˆØ±ÙˆØ¯ ÙØ±ÙˆØ´Ù†Ø¯Ù‡</h2>
      <form onsubmit="stallLogin(event)">
        <div class="form-group">
          <label>Ú©Ø¯ ØºØ±ÙÙ‡</label>
          <input type="text" id="stallCode" placeholder="Ù…Ø«Ø§Ù„: FOOD1" required>
        </div>
        <div class="form-group">
          <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
          <input type="password" id="stallPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ØºØ±ÙÙ‡" required>
        </div>
        <button type="submit" class="btn">ÙˆØ±ÙˆØ¯</button>
        <button type="button" class="btn ghost" onclick="showPanel('entryScreen')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <p style="margin-top:12px;font-size:0.9rem;color:#cbd5f5;">Ù†Ù…ÙˆÙ†Ù‡: FOOD1/food123 â€“ DRINK1/drink123 â€“ GAME1/game123</p>
      </form>
    </section>

    <section id="adminLoginPanel" class="card panel">
      <h2>ğŸ‘¨â€ğŸ’¼ ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±</h2>
      <form onsubmit="adminLogin(event)">
        <div class="form-group">
          <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
          <input type="password" id="adminPassword" placeholder="Ø±Ù…Ø² Ù…Ø¯ÛŒØ±" required>
        </div>
        <button type="submit" class="btn">ÙˆØ±ÙˆØ¯</button>
        <button type="button" class="btn ghost" onclick="showPanel('entryScreen')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
      </form>
    </section>

    <section id="stallPanel" class="panel">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2>ğŸ§‘â€ğŸ³ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ <span id="boothNameDisplay"></span></h2>
          <div style="display:flex;gap:10px;">
            <button class="btn small" onclick="refreshStallData()">ğŸ”„ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
            <button class="btn small ghost" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>

        <div class="tabs">
          <div class="tab-btn active" onclick="switchStallTab('sale')">ğŸ“ Ø«Ø¨Øª ÙØ±ÙˆØ´</div>
          <div class="tab-btn" onclick="switchStallTab('report')">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ ØºØ±ÙÙ‡</div>
          <div class="tab-btn" onclick="switchStallTab('debts')">ğŸ’³ ØªØ³ÙˆÛŒÙ‡ Ø¨Ø¯Ù‡ÛŒ</div>
        </div>

        <div id="saleTab" class="tab-content" style="margin-top:20px;">
          <h3>ğŸ“ Ø«Ø¨Øª ÙØ±ÙˆØ´</h3>
          <form onsubmit="submitSale(event)">
            <div class="form-group">
              <label>Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</label>
              <input type="text" id="studentSearch" placeholder="Ú©Ø¯ØŒ Ù†Ø§Ù… ÛŒØ§ Ú©Ù„Ø§Ø³" oninput="searchStudents()" autocomplete="off">
              <div id="searchResults" class="search-results"></div>
            </div>
            <div class="form-group">
              <label>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</label>
              <input type="text" id="selectedStudent" readonly placeholder="Ø§Ø¨ØªØ¯Ø§ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯">
              <input type="hidden" id="selectedStudentCode">
            </div>
            <div class="form-group">
              <label>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label>
              <input type="number" id="amount" placeholder="10000" required>
            </div>
            <div class="form-group">
              <label>Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª</label>
              <select id="paymentType" required>
                <option value="Ù†Ù‚Ø¯">ğŸ’° Ù†Ù‚Ø¯</option>
                <option value="Ù†Ø³ÛŒÙ‡">ğŸ“ Ù†Ø³ÛŒÙ‡</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ø´Ø±Ø­ Ø§Ù‚Ù„Ø§Ù…</label>
              <textarea id="description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø®ØªÛŒØ§Ø±ÛŒ..."></textarea>
            </div>
            <button type="submit" class="btn success">Ø«Ø¨Øª ÙØ±ÙˆØ´</button>
          </form>
        </div>

        <div id="reportTab" class="tab-content" style="display:none;margin-top:20px;">
          <h3>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ ØºØ±ÙÙ‡</h3>
          <div id="boothStatsDisplay" class="stats-grid"></div>
          <h3 style="margin-top:24px;">ğŸ“… ÙØ±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</h3>
          <div id="todaySalesDisplay"></div>
          <button class="btn small" onclick="refreshStallData()" style="margin-top:16px;">ğŸ”ƒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
        </div>

        <div id="debtsTab" class="tab-content" style="display:none;margin-top:20px;">
          <h3>ğŸ’³ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ ØºØ±ÙÙ‡ Ø´Ù…Ø§</h3>
          <div id="boothDebtsDisplay"></div>
          <button class="btn small" onclick="loadBoothDebts()" style="margin-top:16px;">ğŸ”ƒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯</button>
        </div>
      </div>
    </section>

    <section id="adminPanel" class="panel">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2>ğŸ‘¨â€ğŸ’¼ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
          <div style="display:flex;gap:10px;">
            <button class="btn small" onclick="refreshAdminData()">ğŸ”„ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
            <button class="btn small ghost" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>
        <p style="color:#cbd5f5;margin-bottom:24px;">Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø§Ø² ÙØ±ÙˆØ´ØŒ Ø¨Ø¯Ù‡ÛŒ Ùˆ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</p>

        <div class="tabs">
          <div class="tab-btn active" onclick="switchAdminTab('booths')">ğŸ“ˆ Ø¢Ù…Ø§Ø± ØºØ±ÙÙ‡â€ŒÙ‡Ø§</div>
          <div class="tab-btn" onclick="switchAdminTab('debtors')">ğŸ’³ Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù†</div>
          <div class="tab-btn" onclick="switchAdminTab('sales')">ğŸ“Š Ú©Ù„ ÙØ±ÙˆØ´â€ŒÙ‡Ø§</div>
          <div class="tab-btn" onclick="switchAdminTab('upload')">ğŸ“¥ Ø¢Ù¾Ù„ÙˆØ¯ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</div>
        </div>

        <div id="boothsTab" class="tab-content" style="margin-top:20px;">
          <h3>Ø¢Ù…Ø§Ø± ÙØ±ÙˆØ´ ØºØ±ÙÙ‡â€ŒÙ‡Ø§</h3>
          <div id="boothsStatsDisplay"></div>
        </div>

        <div id="debtorsTab" class="tab-content" style="display:none;margin-top:20px;">
          <h3>Ù„ÛŒØ³Øª Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù†</h3>
          <div id="debtorsDisplay"></div>
          <button class="btn small warning" onclick="downloadDebtorsExcel()" style="margin-top:16px;">Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel</button>
        </div>

        <div id="salesTab" class="tab-content" style="display:none;margin-top:20px;">
          <h3>ØªÙ…Ø§Ù… ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
          <div id="allSalesDisplay"></div>
          <button class="btn small warning" onclick="downloadSalesExcel()" style="margin-top:16px;">Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel</button>
        </div>

        <div id="uploadTab" class="tab-content" style="display:none;margin-top:20px;">
          <h3>Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</h3>
          <p style="color:#cbd5f5;margin-bottom:12px;">ÙØ§ÛŒÙ„ Excel Ø¨Ø§ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ: Ú©Ø¯ | Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ | Ú©Ù„Ø§Ø³</p>
          <input type="file" id="studentsFile" accept=".xlsx,.xls" style="margin-bottom:16px;">
          <button class="btn success" onclick="uploadStudentsFile()">ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯</button>
        </div>
      </div>
    </section>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbw_YHbMkgUdZjFKBGIM0Da43Gu03QnyDKXHxCDFLDUayM6hqcy1_b5fSngTElarxGLjqw/exec';
  
  let currentBoothCode = '';
  let currentBoothName = '';
  let allStudents = [];

  function showPanel(panelId) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById(panelId).classList.add('active');
  }

  function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
  }

  async function apiCall(action, data = {}) {
    try {
      const formData = new FormData();
      formData.append('action', action);
      
      Object.keys(data).forEach(key => {
        if (data[key] !== null && data[key] !== undefined) {
          formData.append(key, data[key]);
        }
      });
      
      const response = await fetch(API_URL, {
        method: 'POST',
        body: formData,
        redirect: 'follow'
      });
      
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        const text = await response.text();
        console.error('Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±:', text);
        throw new Error('Ø³Ø±ÙˆØ± JSON Ø¨Ø±Ù†Ú¯Ø±Ø¯Ø§Ù†Ø¯');
      }
      
      return await response.json();
      
    } catch (error) {
      console.error('Ø®Ø·Ø§ÛŒ Ú©Ø§Ù…Ù„:', error);
      showToast('Ø®Ø·Ø§: ' + error.message, 'error');
      throw error;
    }
  }

  async function stallLogin(e) {
    e.preventDefault();
    const boothCode = document.getElementById('stallCode').value.trim();
    const password = document.getElementById('stallPassword').value;

    const result = await apiCall('login', {
      username: boothCode,
      password: password,
      role: 'vendor'
    });
    
    if (result.success) {
      currentBoothCode = result.data.vendorCode;
      currentBoothName = result.data.vendorName;
      document.getElementById('boothNameDisplay').textContent = currentBoothName;
      showPanel('stallPanel');
      refreshStallData();
      showToast('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚');
    } else {
      showToast(result.message, 'error');
    }
  }

  async function adminLogin(e) {
    e.preventDefault();
    const password = document.getElementById('adminPassword').value;

    const result = await apiCall('login', {
      username: 'admin',
      password: password,
      role: 'admin'
    });
    
    if (result.success) {
      showPanel('adminPanel');
      refreshAdminData();
      showToast('ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ± Ù…ÙˆÙÙ‚');
    } else {
      showToast(result.message, 'error');
    }
  }

  async function loadStudents() {
    const result = await apiCall('getStudents');
    if (result.success) {
      allStudents = result.data;
    }
  }

  function searchStudent() {
    const query = document.getElementById('studentSearch').value.trim();
    const resultsDiv = document.getElementById('studentResults');
    
    if (query.length < 2) {
      resultsDiv.innerHTML = '';
      return;
    }

    const filtered = allStudents.filter(s => 
      s.code.includes(query) || s.name.includes(query)
    );

    resultsDiv.innerHTML = filtered.map(s => `
      <div class="student-item" onclick="selectStudent('${s.code}', '${s.name}', '${s.class}')">
        <strong>${s.code}</strong> - ${s.name} (${s.class})
      </div>
    `).join('');
  }

  function selectStudent(code, name, className) {
    document.getElementById('selectedStudent').innerHTML = `
      <div><strong>Ú©Ø¯:</strong> ${code}</div>
      <div><strong>Ù†Ø§Ù…:</strong> ${name}</div>
      <div><strong>Ú©Ù„Ø§Ø³:</strong> ${className}</div>
    `;
    document.getElementById('selectedStudentCode').value = code;
    document.getElementById('studentResults').innerHTML = '';
    document.getElementById('studentSearch').value = '';
  }

  async function recordSale(e) {
    e.preventDefault();
    
    const studentCode = document.getElementById('selectedStudentCode').value;
    const amount = document.getElementById('saleAmount').value;
    const paymentType = document.getElementById('paymentType').value;
    const description = document.getElementById('saleDescription').value;

    if (!studentCode || !amount) {
      showToast('Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯', 'error');
      return;
    }

    const result = await apiCall('recordSale', {
      vendorCode: currentBoothCode,
      studentCode: studentCode,
      amount: amount,
      paymentType: paymentType,
      description: description
    });

    if (result.success) {
      showToast('ÙØ±ÙˆØ´ Ø«Ø¨Øª Ø´Ø¯');
      document.getElementById('saleForm').reset();
      document.getElementById('selectedStudent').innerHTML = '';
      document.getElementById('selectedStudentCode').value = '';
      refreshStallData();
    } else {
      showToast(result.message, 'error');
    }
  }

  async function refreshStallData() {
    await loadStudents();
    
    const report = await apiCall('getVendorReport', {
      vendorCode: currentBoothCode
    });
    
    if (report.success) {
      const d = report.data;
      document.getElementById('stallTotalSales').textContent = 
        (d.totalCash + d.totalCredit).toLocaleString();
      document.getElementById('stallCashSales').textContent = 
        d.totalCash.toLocaleString();
      document.getElementById('stallCreditSales').textContent = 
        d.totalCredit.toLocaleString();
      document.getElementById('stallTransactionCount').textContent = 
        d.salesCount;
    }

    const sales = await apiCall('getTodaySales', {
      vendorCode: currentBoothCode
    });
    
    if (sales.success) {
      const tbody = document.getElementById('todaySalesBody');
      tbody.innerHTML = sales.data.map(s => `
        <tr>
          <td>${s.time}</td>
          <td>${s.studentCode}</td>
          <td>${s.studentName}</td>
          <td>${Number(s.amount).toLocaleString()}</td>
          <td><span class="badge badge-${s.paymentType === 'Ù†Ù‚Ø¯' ? 'success' : 'warning'}">${s.paymentType}</span></td>
          <td>${s.description}</td>
        </tr>
      `).join('');
    }
  }

  async function refreshAdminData() {
    const stats = await apiCall('getAdminStats');
    
    if (stats.success) {
      const d = stats.data;
      document.getElementById('adminTotalSales').textContent = 
        d.totalSales.toLocaleString();
      document.getElementById('adminCashSales').textContent = 
        d.cashSales.toLocaleString();
      document.getElementById('adminCreditSales').textContent = 
        d.creditSales.toLocaleString();
      document.getElementById('adminTotalDebt').textContent = 
        d.totalDebt.toLocaleString();
      document.getElementById('adminDebtorCount').textContent = 
        d.debtorCount;

      const vendorTbody = document.getElementById('vendorStatsBody');
      vendorTbody.innerHTML = d.vendorStats.map(v => `
        <tr>
          <td>${v.name}</td>
          <td>${v.totalSales.toLocaleString()}</td>
          <td>${v.cashSales.toLocaleString()}</td>
          <td>${v.creditSales.toLocaleString()}</td>
          <td>${v.salesCount}</td>
        </tr>
      `).join('');
    }

    const debtors = await apiCall('getAllDebtors');
    if (debtors.success) {
      const tbody = document.getElementById('debtorsBody');
      tbody.innerHTML = debtors.data.map(d => `
        <tr>
          <td>${d.studentCode}</td>
          <td>${d.studentName}</td>
          <td>${d.className}</td>
          <td>${d.totalDebt.toLocaleString()}</td>
        </tr>
      `).join('');
    }

    const allSales = await apiCall('getAllSales');
    if (allSales.success) {
      const tbody = document.getElementById('allSalesBody');
      tbody.innerHTML = allSales.data.map(s => `
        <tr>
          <td>${s.date}</td>
          <td>${s.time}</td>
          <td>${s.vendorName}</td>
          <td>${s.studentCode}</td>
          <td>${s.studentName}</td>
          <td>${Number(s.amount).toLocaleString()}</td>
          <td><span class="badge badge-${s.paymentType === 'Ù†Ù‚Ø¯' ? 'success' : 'warning'}">${s.paymentType}</span></td>
          <td>${s.description}</td>
        </tr>
      `).join('');
    }
  }

  async function uploadStudents(e) {
    e.preventDefault();
    const fileInput = document.getElementById('studentFile');
    
    if (!fileInput.files[0]) {
      showToast('Ù„Ø·ÙØ§ ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
      return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = async function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

        const students = jsonData.slice(1).map(row => ({
          code: String(row[0] || '').trim(),
          name: String(row[1] || '').trim(),
          class: String(row[2] || '').trim()
        })).filter(s => s.code && s.name);

        const result = await apiCall('uploadStudents', {
          students: JSON.stringify(students)
        });

        if (result.success) {
          showToast(`${students.length} Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯`);
          fileInput.value = '';
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø§:', error);
        showToast('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„', 'error');
      }
    };

    reader.readAsArrayBuffer(file);
  }

  function downloadDebtors() {
    // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel
    showToast('Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯...');
  }

  function downloadAllSales() {
    // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Excel
    showToast('Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯...');
  }

  document.addEventListener('DOMContentLoaded', () => {
    showPanel('entryScreen');
  });
</script>
</body>
</html>



