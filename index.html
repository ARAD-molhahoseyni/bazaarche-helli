<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازارچه علامه حلی ده</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazir', Tahoma, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            padding: 40px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .logo {
            text-align: center;
            font-size: 60px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .quick-pay {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .quick-btn {
            padding: 15px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            background: #667eea;
            color: white;
        }

        .transactions {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .transaction {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-right: 4px solid #667eea;
        }

        .transaction.purchase {
            border-right-color: #ff6b6b;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .transaction-details {
            font-size: 12px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .success {
            background: #efe;
            color: #060;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .back-btn {
            background: none;
            border: 2px solid #667eea;
            color: #667eea;
            width: auto;
            padding: 10px 20px;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- صفحه خوش‌آمدگویی -->
    <div id="welcomePage" class="page active">
        <div class="logo">🏪</div>
        <h1>بازارچه علامه حلی ده</h1>
        <p class="subtitle">سامانه مدیریت کیف پول دیجیتال</p>
        
        <div id="syncStatus" class="loading">در حال اتصال به سرور...</div>
        
        <button class="btn" onclick="showPage('registerPage')">✨ ثبت‌نام</button>
        <button class="btn btn-secondary" onclick="showPage('loginPage')">🔐 ورود</button>
        <button class="btn btn-success" onclick="showPage('adminPage')">👨‍💼 پنل مدیریت</button>
        <button class="btn btn-warning" onclick="syncData()">🔄 همگام‌سازی با سرور</button>
    </div>

    <!-- صفحه ثبت‌نام -->
    <div id="registerPage" class="page">
        <button class="btn back-btn" onclick="showPage('welcomePage')">← بازگشت</button>
        <h1>ثبت‌نام دانش‌آموز</h1>
        <p class="subtitle">اطلاعات خود را وارد کنید</p>
        
        <div id="registerMessage"></div>
        
        <div class="input-group">
            <label>👤 نام و نام خانوادگی:</label>
            <input type="text" id="regName" placeholder="مثال: علی محمدی">
        </div>
        
        <div class="input-group">
            <label>🎫 کد دانش‌آموزی:</label>
            <input type="text" id="regStudentId" placeholder="مثال: 1001">
        </div>
        
        <button class="btn" onclick="registerStudent()">✅ ثبت‌نام</button>
    </div>

    <!-- صفحه ورود -->
    <div id="loginPage" class="page">
        <button class="btn back-btn" onclick="showPage('welcomePage')">← بازگشت</button>
        <h1>ورود به سیستم</h1>
        <p class="subtitle">با کد دانش‌آموزی خود وارد شوید</p>
        
        <div id="loginMessage"></div>
        
        <div class="input-group">
            <label>👤 نام و نام خانوادگی:</label>
            <input type="text" id="loginName" placeholder="مثال: علی محمدی">
        </div>
        
        <div class="input-group">
            <label>🎫 کد دانش‌آموزی:</label>
            <input type="text" id="loginStudentId" placeholder="مثال: 1001">
        </div>
        
        <button class="btn" onclick="loginStudent()">🚀 ورود</button>
    </div>

    <!-- صفحه کیف پول -->
    <div id="walletPage" class="page">
        <button class="btn back-btn" onclick="logout()">← خروج</button>
        <h1>کیف پول</h1>
        <p class="subtitle" id="walletUser"></p>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="balance">0</div>
                <div class="stat-label">موجودی (تومان)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalPurchases">0</div>
                <div class="stat-label">تعداد خریدها</div>
            </div>
        </div>
        
        <h3 style="margin: 20px 0 10px 0;">💳 پرداخت سریع</h3>
        <div class="quick-pay">
            <button class="quick-btn" onclick="quickPay(1000)">۱,۰۰۰ تومان</button>
            <button class="quick-btn" onclick="quickPay(2000)">۲,۰۰۰ تومان</button>
            <button class="quick-btn" onclick="quickPay(5000)">۵,۰۰۰ تومان</button>
            <button class="quick-btn" onclick="quickPay(10000)">۱۰,۰۰۰ تومان</button>
        </div>
        
        <div id="purchaseMessage"></div>
        
        <div class="input-group">
            <label>💰 مبلغ (تومان):</label>
            <input type="number" id="purchaseAmount" placeholder="مبلغ را وارد کنید">
        </div>
        
        <div class="input-group">
            <label>🏪 غرفه:</label>
            <select id="purchaseStall">
                <option value="">در حال بارگذاری...</option>
            </select>
        </div>
        
        <div class="input-group">
            <label>📝 توضیحات (اختیاری):</label>
            <textarea id="purchaseDesc" rows="2" placeholder="توضیحات خرید..."></textarea>
        </div>
        
        <button class="btn" onclick="makePurchase()">✅ پرداخت و خرید</button>
        
        <h3 style="margin: 30px 0 10px 0;">📋 تاریخچه تراکنش‌ها</h3>
        <div id="transactions" class="transactions"></div>
    </div>

    <!-- صفحه مدیریت -->
    <div id="adminPage" class="page">
        <div id="adminLogin">
            <button class="btn back-btn" onclick="showPage('welcomePage')">← بازگشت</button>
            <h1>پنل مدیریت</h1>
            <p class="subtitle">ورود به حساب مدیریت</p>
            
            <div id="adminLoginMessage"></div>
            
            <div class="input-group">
                <label>🔑 رمز عبور:</label>
                <input type="password" id="adminPassword" placeholder="رمز مدیریت را وارد کنید">
            </div>
            
            <button class="btn" onclick="adminLogin()">🚀 ورود به پنل</button>
        </div>
        
        <div id="adminDashboard" style="display:none;">
            <button class="btn back-btn" onclick="adminLogout()">← خروج از پنل</button>
            <h1>داشبورد مدیریت</h1>
            <p class="subtitle">مدیریت بازارچه علامه حلی ده</p>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">دانش‌آموزان</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalStalls">0</div>
                    <div class="stat-label">غرفه‌ها</div>
                </div>
            </div>
            
            <div id="adminMessage"></div>
            
            <h3 style="margin: 20px 0 10px 0;">⚡ شارژ حساب دانش‌آموز</h3>
            <div class="input-group">
                <label>👤 دانش‌آموز:</label>
                <select id="chargeStudent">
                    <option value="">انتخاب دانش‌آموز...</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>💰 مبلغ شارژ (تومان):</label>
                <input type="number" id="chargeAmount" placeholder="مبلغ شارژ">
            </div>
            
            <div class="input-group">
                <label>💵 مبلغ نقدی دریافتی (تومان):</label>
                <input type="number" id="chargeCash" placeholder="مبلغ نقدی">
            </div>
            
            <button class="btn" onclick="chargeStudent()">⚡ شارژ حساب</button>
            
            <h3 style="margin: 30px 0 10px 0;">➕ افزودن غرفه جدید</h3>
            <div class="input-group">
                <label>🏪 نام غرفه:</label>
                <input type="text" id="stallName" placeholder="مثال: غرفه کتاب">
            </div>
            
            <div class="input-group">
                <label>🎫 کد غرفه:</label>
                <input type="text" id="stallCode" placeholder="مثال: BOOK1">
            </div>
            
            <button class="btn btn-success" onclick="addStall()">➕ افزودن غرفه</button>
            
            <h3 style="margin: 30px 0 10px 0;">📊 گزارشات</h3>
            <div id="adminReports" class="transactions"></div>
            
            <button class="btn btn-danger" onclick="resetSystem()" style="margin-top: 30px;">🗑️ ریست کامل سیستم</button>
        </div>
    </div>
</div>

<script>
// ========== تنظیمات اصلی ==========
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzTPmSoXHk4U6Z-GO8R91f_xWm6iL6hvWIVX8T3fhHzrhP6GJZYbmTyqEKxzl_WUmw9/exec'; // آدرس Apps Script که کپی کردید
const ADMIN_PASS = '';

let currentUser = null;
let allData = {
    students: [],
    charges: [],
    purchases: [],
    stalls: []
};

// ========== توابع کمکی ==========
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
}

function showMessage(elementId, message, type = 'error') {
    const el = document.getElementById(elementId);
    el.className = type;
    el.textContent = message;
    setTimeout(() => el.textContent = '', 5000);
}

function formatNumber(num) {
    return new Intl.NumberFormat('fa-IR').format(num);
}

// ========== API Calls ==========
async function callAPI(action, params = {}) {
    try {
        const url = new URL(SCRIPT_URL);
        url.searchParams.append('action', action);
        Object.keys(params).forEach(key => {
            url.searchParams.append(key, params[key]);
        });
        
        const response = await fetch(url);
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('API Error:', error);
        return { success: false, error: 'خطا در اتصال به سرور' };
    }
}

// ========== راه‌اندازی اولیه ==========
async function initSystem() {
    const result = await callAPI('init');
    if (result.success) {
        await syncData();
    }
}

async function syncData() {
    document.getElementById('syncStatus').textContent = 'در حال دریافت اطلاعات...';
    
    const result = await callAPI('getAll');
    if (result.success) {
        allData = result;
        document.getElementById('syncStatus').className = 'success';
        document.getElementById('syncStatus').textContent = '✅ اتصال برقرار است';
        
        updateAdminData();
    } else {
        document.getElementById('syncStatus').className = 'error';
        document.getElementById('syncStatus').textContent = '❌ خطا در اتصال';
    }
}

// ========== ثبت‌نام ==========
async function registerStudent() {
    const name = document.getElementById('regName').value.trim();
    const studentId = document.getElementById('regStudentId').value.trim();
    
    if (!name || !studentId) {
        showMessage('registerMessage', 'لطفاً تمام فیلدها را پر کنید');
        return;
    }
    
    const result = await callAPI('saveStudent', { name, studentId });
    
    if (result.success) {
        showMessage('registerMessage', '✅ ثبت‌نام با موفقیت انجام شد!', 'success');
        await syncData();
        setTimeout(() => showPage('loginPage'), 2000);
    } else {
        showMessage('registerMessage', result.error || 'خطا در ثبت‌نام');
    }
}

// ========== ورود ==========
async function loginStudent() {
    const name = document.getElementById('loginName').value.trim();
    const studentId = document.getElementById('loginStudentId').value.trim();
    
    if (!name || !studentId) {
        showMessage('loginMessage', 'لطفاً تمام فیلدها را پر کنید');
        return;
    }
    
    await syncData();
    
    const student = allData.students.find(s => 
        s.studentId == studentId && s.name === name
    );
    
    if (student) {
        currentUser = student;
        showWallet();
    } else {
        showMessage('loginMessage', 'اطلاعات وارد شده صحیح نیست');
    }
}

function logout() {
    currentUser = null;
    showPage('welcomePage');
}

// ========== کیف پول ==========
async function showWallet() {
    await syncData();
    
    const student = allData.students.find(s => s.studentId == currentUser.studentId);
    if (!student) {
        logout();
        return;
    }
    
    currentUser = student;
    
    document.getElementById('walletUser').textContent = `${currentUser.name} - کد: ${currentUser.studentId}`;
    document.getElementById('balance').textContent = formatNumber(currentUser.balance || 0);
    
    // تعداد خریدها
    const userPurchases = allData.purchases.filter(p => p.studentId == currentUser.studentId);
    document.getElementById('totalPurchases').textContent = formatNumber(userPurchases.length);
    
    // غرفه‌ها
    const stallSelect = document.getElementById('purchaseStall');
    stallSelect.innerHTML = '<option value="">انتخاب غرفه...</option>';
    allData.stalls.forEach(stall => {
        const option = document.createElement('option');
        option.value = stall.code;
        option.textContent = stall.name;
        stallSelect.appendChild(option);
    });
    
    // تراکنش‌ها
    const transDiv = document.getElementById('transactions');
    transDiv.innerHTML = '';
    
    const userCharges = allData.charges.filter(c => c.studentId == currentUser.studentId);
    const allTransactions = [
        ...userCharges.map(c => ({ ...c, type: 'charge' })),
        ...userPurchases.map(p => ({ ...p, type: 'purchase' }))
    ].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    allTransactions.forEach(t => {
        const div = document.createElement('div');
        div.className = `transaction ${t.type}`;
        div.innerHTML = `
            <div class="transaction-header">
                <span>${t.type === 'charge' ? '⚡ شارژ' : '🛒 خرید'}</span>
                <span>${formatNumber(t.amount)} تومان</span>
            </div>
            <div class="transaction-details">
                ${t.type === 'charge' ? 'شارژ حساب' : (t.stall + ' - ' + (t.description || 'خرید'))}
                <br>
                ${new Date(t.date).toLocaleString('fa-IR')}
            </div>
        `;
        transDiv.appendChild(div);
    });
    
    showPage('walletPage');
}

function quickPay(amount) {
    document.getElementById('purchaseAmount').value = amount;
}

async function makePurchase() {
    const amount = parseInt(document.getElementById('purchaseAmount').value);
    const stall = document.getElementById('purchaseStall').value;
    const description = document.getElementById('purchaseDesc').value.trim();
    
    if (!amount || !stall) {
        showMessage('purchaseMessage', 'لطفاً مبلغ و غرفه را انتخاب کنید');
        return;
    }
    
    if (amount > currentUser.balance) {
        showMessage('purchaseMessage', 'موجودی کافی نیست!');
        return;
    }
    
    const result = await callAPI('savePurchase', {
        studentId: currentUser.studentId,
        amount,
        stall,
        description
    });
    
    if (result.success) {
        showMessage('purchaseMessage', '✅ خرید با موفقیت انجام شد!', 'success');
        document.getElementById('purchaseAmount').value = '';
        document.getElementById('purchaseDesc').value = '';
        await showWallet();
    } else {
        showMessage('purchaseMessage', result.error || 'خطا در خرید');
    }
}

// ========== پنل ادمین ==========
function adminLogin() {
    const pass = document.getElementById('adminPassword').value;
    
    if (pass === ADMIN_PASS) {
        document.getElementById('adminLogin').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        updateAdminData();
    } else {
        showMessage('adminLoginMessage', 'رمز عبور اشتباه است');
    }
}

function adminLogout() {
    document.getElementById('adminLogin').style.display = 'block';
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('adminPassword').value = '';
    showPage('welcomePage');
}

async function updateAdminData() {
    await syncData();
    
    document.getElementById('totalStudents').textContent = formatNumber(allData.students.length);
    document.getElementById('totalStalls').textContent = formatNumber(allData.stalls.length);
    
    // لیست دانش‌آموزان برای شارژ
    const chargeSelect = document.getElementById('chargeStudent');
    chargeSelect.innerHTML = '<option value="">انتخاب دانش‌آموز...</option>';
    allData.students.forEach(student => {
        const option = document.createElement('option');
        option.value = student.studentId;
        option.textContent = `${student.name} (کد: ${student.studentId}) - موجودی: ${formatNumber(student.balance)} تومان`;
        chargeSelect.appendChild(option);
    });
    
    // گزارشات
    const reportsDiv = document.getElementById('adminReports');
    reportsDiv.innerHTML = '';
    
    allData.charges.slice().reverse().slice(0, 10).forEach(c => {
        const div = document.createElement('div');
        div.className = 'transaction';
        div.innerHTML = `
            <div class="transaction-header">
                <span>⚡ شارژ: ${c.name}</span>
                <span>${formatNumber(c.amount)} تومان</span>
            </div>
            <div class="transaction-details">
                نقدی: ${formatNumber(c.cash)} تومان
                <br>
                ${new Date(c.date).toLocaleString('fa-IR')}
            </div>
        `;
        reportsDiv.appendChild(div);
    });
}

async function chargeStudent() {
    const studentId = document.getElementById('chargeStudent').value;
    const amount = parseInt(document.getElementById('chargeAmount').value);
    const cash = parseInt(document.getElementById('chargeCash').value);
    
    if (!studentId || !amount || !cash) {
        showMessage('adminMessage', 'لطفاً تمام فیلدها را پر کنید');
        return;
    }
    
    const result = await callAPI('saveCharge', { studentId, amount, cash });
    
    if (result.success) {
        showMessage('adminMessage', '✅ شارژ با موفقیت انجام شد!', 'success');
        document.getElementById('chargeAmount').value = '';
        document.getElementById('chargeCash').value = '';
        await updateAdminData();
    } else {
        showMessage('adminMessage', result.error || 'خطا در شارژ');
    }
}

async function addStall() {
    const name = document.getElementById('stallName').value.trim();
    const code = document.getElementById('stallCode').value.trim().toUpperCase();
    
    if (!name || !code) {
        showMessage('adminMessage', 'لطفاً نام و کد غرفه را وارد کنید');
        return;
    }
    
    const result = await callAPI('saveStall', { name, code });
    
    if (result.success) {
        showMessage('adminMessage', '✅ غرفه با موفقیت اضافه شد!', 'success');
        document.getElementById('stallName').value = '';
        document.getElementById('stallCode').value = '';
        await updateAdminData();
    } else {
        showMessage('adminMessage', result.error || 'خطا در افزودن غرفه');
    }
}

async function resetSystem() {
    if (!confirm('⚠️ تمام داده‌ها پاک خواهند شد! آیا مطمئن هستید؟')) return;
    if (!confirm('⚠️⚠️ این عملیات غیرقابل بازگشت است! دوباره تأیید کنید:')) return;
    
    // این بخش نیاز به تابع جداگانه در Apps Script دارد
    alert('برای ریست کامل، از Google Sheets مستقیماً جداول را پاک کنید و دوباره اسکریپت را اجرا کنید.');
}

// ========== شروع برنامه ==========
window.onload = async function() {
    await initSystem();
};
</script>

</body>
</html>
زب
